

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master Bar Control v9.1 (Light Edition)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- CLEAN LIGHT THEME --- */
        :root {
            --theme-font: 'Inter', sans-serif;
            --bg-body: #f8fafc; /* Slate 50 */
            --bg-card: #ffffff;
            --text-main: #0f172a; /* Slate 900 */
            --text-secondary: #64748b; /* Slate 500 */
            --accent-blue: #2563eb; /* Blue 600 */
            --border-color: #e2e8f0; /* Slate 200 */
        }
        
        body { 
            background-color: var(--bg-body);
            color: var(--text-main); 
            font-family: var(--theme-font), system-ui, sans-serif; 
            min-height: 100vh; 
            overscroll-behavior-y: none;
            -webkit-font-smoothing: antialiased;
        }

        /* Override Tailwind Classes for Global Consistency */
        .bg-\[\#1D1F23\], .bg-\[\#0A0A0A\], .bg-\[\#050505\] {
            background-color: var(--bg-card) !important;
            border: 1px solid var(--border-color) !important;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1) !important; /* Shadow-sm */
            color: var(--text-main) !important;
        }

        .border-white\/10, .border-white\/5 {
            border-color: var(--border-color) !important;
        }

        .text-white { color: var(--text-main) !important; }
        .text-white\/40, .text-white\/30, .text-white\/50, .text-white\/60 { color: var(--text-secondary) !important; }
        
        /* Inputs Light Mode */
        input, select {
            background-color: #f1f5f9 !important; /* Slate 100 */
            border: 1px solid var(--border-color) !important;
            color: var(--text-main) !important;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        input:focus, select:focus {
            background-color: #ffffff !important;
            border-color: var(--accent-blue) !important;
            outline: 2px solid rgba(37, 99, 235, 0.2) !important;
            box-shadow: none !important;
        }

        /* Buttons & Modals */
        .backdrop-blur-xl {
            backdrop-filter: blur(8px) !important;
            background-color: rgba(255, 255, 255, 0.9) !important;
        }
        
        /* Fixed Header Background */
        header.bg-\[\#050505\]\/80 {
            background-color: rgba(255, 255, 255, 0.95) !important;
            border-bottom: 1px solid var(--border-color) !important;
            color: var(--text-main) !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .animate-in { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .h-21 { height: 5.25rem; } .w-21 { width: 5.25rem; }
        #pdf-chart-canvas { position: fixed; left: 100vw; top: 0; z-index: -100; background-color: white; display: block; }
    </style>
</head>
<body>
    <div id="root">
        <div style="height: 100vh; display: flex; align-items: center; justify-content: center; color: #2563eb; flex-direction: column; gap: 1rem; background: #f8fafc;">
            <div class="animate-pulse tracking-widest font-semibold text-sm text-slate-500">INITIALIZING SYSTEM v9.1...</div>
        </div>
    </div>
    
    <canvas id="pdf-chart-canvas" width="800" height="600"></canvas>
  <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        
        window.fb = { initializeApp, getFirestore, doc, setDoc, onSnapshot, getDoc, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, collection };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, Component } = React;

        const SafeStorage = {
            getItem: (key) => { try { return localStorage.getItem(key); } catch (e) { return null; } },
            setItem: (key, value) => { try { localStorage.setItem(key, value); } catch (e) { } }
        };

        const APP_VERSION = "9.1";
        const BUILD_ID = "LIGHT_PC_EDITION";

        // ‚úÖ CREDENCIALES
        const FIREBASE_CONFIG = { 
            apiKey: "AIzaSyDqdJcKILp5kQ4sTxVm8Ch5E7oXfMD3BAM",
            authDomain: "master-control-palmas.firebaseapp.com",
            projectId: "master-control-palmas",
            storageBucket: "master-control-palmas.firebasestorage.app",
            messagingSenderId: "681752784684",
            appId: "1:681752784684:web:e4a4a4ce96d587380d4689"
        };
        
        const ENV_APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const ENV_FIREBASE_CONFIG = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const ENV_AUTH_TOKEN = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- RECIPES & DATA ---
        const COCKTAIL_RECIPES = [
            { name: "Sex on the Beach", ingredients: [{ name: "Barton Naturals Vodka", qty: 1 }, { name: "Peach Schnapps Boston", qty: 1 }] },
            { name: "Green Tea Shot", ingredients: [{ name: "Jameson", qty: 0.5 }, { name: "Peach Schnapps Boston", qty: 0.5 }] },
            { name: "Tequila Sunrise", ingredients: [{ name: "Montezuma White", qty: 1 }] },
            { name: "Caribbean Drop", ingredients: [{ name: "Bacardi Limon", qty: 1 }] },
            { name: "Margarita", ingredients: [{ name: "Montezuma White", qty: 1 }] },
            { name: "Strawberry Margarita", ingredients: [{ name: "Montezuma White", qty: 1 }] },
            { name: "Moscow Mule", ingredients: [{ name: "Barton Naturals Vodka", qty: 1 }] },
            { name: "Mojito", ingredients: [{ name: "Bacardi Light", qty: 1 }] },
            { name: "Amaretto Sour", ingredients: [{ name: "Disaronno Amaretto", qty: 2 }] },
            { name: "Blue MF", ingredients: [{ name: "Long Island Tea Mix", qty: 2 }, { name: "Curacao Blue", qty: 0.5 }] },
            { name: "Long Island Ice Tea", ingredients: [{ name: "Long Island Tea Mix", qty: 2 }, { name: "Triple Sec Boston", qty: 0.5 }] },
            { name: "Screwdriver", ingredients: [{ name: "Barton Naturals Vodka", qty: 1 }] },
            { name: "Cuba Libre", ingredients: [{ name: "Bacardi Light", qty: 1 }] }
        ];

        const PITCHER_RECIPES = [
            { name: "Sex on the Beach PITCHER", ingredients: [{ name: "Barton Naturals Vodka", qty: 5 }, { name: "Peach Schnapps Boston", qty: 5 }] }, 
            { name: "Margarita PITCHER", ingredients: [{ name: "Montezuma White", qty: 5 }, { name: "Peach Schnapps Boston", qty: 5 }] },
            { name: "Tequila Sunrise PITCHER", ingredients: [{ name: "Montezuma White", qty: 5 }, { name: "Peach Schnapps Boston", qty: 5 }] },
            { name: "Jameson PITCHER", ingredients: [{ name: "Jameson", qty: 10 }] },
            { name: "Blue MF PITCHER", ingredients: [{ name: "Long Island Tea Mix", qty: 10 }, { name: "Curacao Blue", qty: 2.5 }] },
            { name: "Long Island PITCHER", ingredients: [{ name: "Long Island Tea Mix", qty: 10 }, { name: "Triple Sec Boston", qty: 2.5 }] }
        ];

        const PAR_LEVELS = {
            "Crown Royal Regal": 2, "Apple Crown Royal": 2, "Jack Daniels Black": 3, "Jameson": 2, "WoodFord Reserve": 1,
            "Buchanans 12": 6, "Johnnie Walker Black": 4, "Grand Old Parr 12": 2, "Hennessy VS": 3, "Tito's Texas Vodka": 3,
            "Remy Martin": 2, "Grey Goose": 3, "Casamigos Blanco": 4, "Casamigos Reposado": 2, "Espolon Blanco": 2,
            "Espolon Reposado": 1, "Don Julio Blanco": 6, "Don Julio Reposado": 2, "Patron Silver": 6, "Patron Reposado": 1,
            "Fernet Branca": 2, "Brugal Anejo": 2, "Montezuma White": 12, "Barton Naturals Vodka": 12, "Long Island Tea Mix": 6,
            "Peach Schnapps Boston": 12, "Triple Sec Boston": 12, "Bacardi Light": 6, "Capitan Morgan Spice": 2, "Jagermeister": 1, 
            "Malibu": 6, "Barton Gin": 6, "Curacao Blue": 4, "Sour Apple": 4, "Sour Apple HW": 4, "Sour Cherry Boston": 4,
            "Modelo Especial": 600, "Corona": 720, "Michelob Ultra": 72, "Heineken": 48, "Pacifico": 48,
            "Red Bull Regular": 96, "Red Bull Sugar Free": 72, "Red Bull Watermelon": 48, "High Noon Variety Pack": 48,
            "Cafayate Malbec": 1, "Procecco Zonin": 6, "Sangria": 12,
            "Coca Cola": 48, "Diet Coke": 24, "Sprite": 48, "Ginger Ale": 24, "Water Bottle": 96
        };

        const ZONES_CONFIG = {
            bar1: [
                { id: 'bar1_cooler', label: 'Cooler Beer', icon: 'üßä', group: 'Cooler Area' },
                { id: 'bar1_small_cooler_1', label: 'Small 1', icon: '‚ùÑÔ∏è', group: 'Cooler Area' },
                { id: 'bar1_small_cooler_2', label: 'Small 2', icon: '‚ùÑÔ∏è', group: 'Cooler Area' },
                { id: 'bar1_reaching', label: 'Reaching', icon: '‚úã', group: 'Reaching/Wells' },
                { id: 'bar1_shelf_full', label: 'Shelf Full', icon: 'üçæ', group: 'Shelf' },
                { id: 'bar1_shelf_open', label: 'Shelf Open', icon: 'ü•É', group: 'Shelf' },
                { id: 'bar1_well_1', label: 'Well 1', icon: 'ü•É', group: 'Reaching/Wells' },
                { id: 'bar1_well_2', label: 'Well 2', icon: 'ü•É', group: 'Reaching/Wells' }
            ],
            bar2: [
                { id: 'bar2_cooler', label: 'Cooler', icon: 'üßä' },
                { id: 'bar2_small_cooler', label: 'Small Cooler', icon: '‚ùÑÔ∏è' }
            ],
            bodega: [
                { id: 'bodega_closet', label: 'Closet', icon: 'üö™' },
                { id: 'bodega_shelves', label: 'Shelves', icon: 'üóÑÔ∏è' }
            ]
        };
        // ESTA ES LA PARTE 2 DE 5

        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) return <div className="p-10 text-center text-red-600 bg-red-50 h-screen flex flex-col justify-center items-center"><div>SYSTEM ERROR</div><div className="text-xs mt-2">{this.state.error?.toString()}</div></div>;
                return this.props.children;
            }
        }

        // --- ICONS ---
        const IconWrapper = ({ children, className, size = 24 }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Icons = {
            Beer: (p) => <IconWrapper {...p}><path d="M17 11h1a3 3 0 0 1 0 6h-1"/><path d="M9 12h6"/><path d="M9 12v3a8 8 0 0 1-16 0v-3"/><path d="M22 6h-7a2 2 0 0 0-2 2v2"/><path d="M5 12V3a2 2 0 0 1 2-2h7"/></IconWrapper>,
            Wine: (p) => <IconWrapper {...p}><path d="M8 22h8"/><path d="M7 10h10"/><path d="M12 15v7"/><path d="M12 15a5 5 0 0 0 5-5c0-2-.5-4-2-8H9c-1.5 4-2 6-2 8a5 5 0 0 0 5 5Z"/></IconWrapper>,
            GlassWater: (p) => <IconWrapper {...p}><path d="M15.2 22H8.8a2 2 0 0 1-2-1.79L5 3h14l-1.81 17.21A2 2 0 0 1 15.2 22Z"/><path d="M6 12a5 5 0 0 1 6 0 5 5 0 0 0 6 0"/></IconWrapper>,
            Package: (p) => <IconWrapper {...p}><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></IconWrapper>,
            Search: (p) => <IconWrapper {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconWrapper>,
            Download: (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconWrapper>,
            ChevronDown: (p) => <IconWrapper {...p}><path d="m6 9 6 6 6-6"/></IconWrapper>,
            ChevronUp: (p) => <IconWrapper {...p}><path d="m18 15-6-6-6 6"/></IconWrapper>,
            AlertTriangle: (p) => <IconWrapper {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconWrapper>,
            CheckCircle: (p) => <IconWrapper {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></IconWrapper>,
            RotateCcw: (p) => <IconWrapper {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconWrapper>,
            Calculator: (p) => <IconWrapper {...p}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconWrapper>,
            MapPin: (p) => <IconWrapper {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconWrapper>,
            DollarSign: (p) => <IconWrapper {...p}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconWrapper>,
            ShoppingCart: (p) => <IconWrapper {...p}><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></IconWrapper>,
            RefreshCw: (p) => <IconWrapper {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconWrapper>,
            Box: (p) => <IconWrapper {...p}><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></IconWrapper>,
            ArrowRight: (p) => <IconWrapper {...p}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></IconWrapper>,
            ArrowLeft: (p) => <IconWrapper {...p}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></IconWrapper>,
            Trash: (p) => <IconWrapper {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></IconWrapper>,
            BarChart: (p) => <IconWrapper {...p}><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></IconWrapper>,
            Cloud: (p) => <IconWrapper {...p}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M17.5 19c3.037 0 5.5-2.463 5.5-5.5S20.537 8 17.5 8"/><path d="M17.5 8c0-3.037-2.463-5.5-5.5-5.5S6.5 4.963 6.5 8"/><path d="M6.5 19C3.463 19 1 16.537 1 13.5S3.463 8 6.5 8"/></IconWrapper>,
            HardDrive: (p) => <IconWrapper {...p}><line x1="22" x2="22" y1="12" y2="12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/><line x1="6" x2="6.01" y1="16" y2="16"/><line x1="10" x2="10.01" y1="16" y2="16"/></IconWrapper>,
            Save: (p) => <IconWrapper {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>,
            Upload: (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconWrapper>,
            Scan: (p) => <IconWrapper {...p}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><rect width="10" height="6" x="7" y="9" rx="1"/></IconWrapper>,
            Barcode: (p) => <IconWrapper {...p}><path d="M3 5v14"/><path d="M8 5v14"/><path d="M12 5v14"/><path d="M17 5v14"/><path d="M21 5v14"/></IconWrapper>,
            ErrorIcon: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconWrapper>,
            Plus: (p) => <IconWrapper {...p}><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></IconWrapper>,
            Leaf: (p) => <IconWrapper {...p}><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.77 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></IconWrapper>,
            List: (p) => <IconWrapper {...p}><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></IconWrapper>,
            FileText: (p) => <IconWrapper {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconWrapper>,
            GitMerge: (p) => <IconWrapper {...p}><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M6 21V9a9 9 0 0 0 9 9"/></IconWrapper>,
            Clock: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconWrapper>,
            Settings: (p) => <IconWrapper {...p}><path d="M12.22 2h-.44a2 2 0 0 1-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconWrapper>,
            Cocktail: (p) => <IconWrapper {...p}><path d="M8 21h8"/><path d="M12 21v-7"/><path d="M6 4h12a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z"/></IconWrapper>,
            Pitcher: (p) => <IconWrapper {...p}><path d="M16 2v2h4a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-4"/><path d="M10 2v2"/><path d="M7 2h10a2 2 0 0 1 2 2v14a4 4 0 0 1-4 4H9a4 4 0 0 1-4-4V4a2 2 0 0 1 2-2Z"/></IconWrapper>,
            Star: (p) => <IconWrapper {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconWrapper>
        };

        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination); const now = ctx.currentTime;
                if (type === 'success') { osc.frequency.setValueAtTime(1000, now); osc.frequency.exponentialRampToValueAtTime(2000, now + 0.1); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5); }
                else if (type === 'error') { osc.type = "sawtooth"; osc.frequency.setValueAtTime(150, now); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.3); }
                else { osc.frequency.setValueAtTime(600, now); gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1); }
                osc.start(now); osc.stop(now + 0.5);
            } catch (e) {}
        };

        const CategoryHeader = ({ title, icon: Icon, isOpen, toggle }) => (
            <button onClick={toggle} className="w-full flex items-center justify-between p-4 bg-white border border-slate-200 hover:border-blue-400 hover:shadow-md rounded-xl shadow-sm mb-2 transition-all duration-300 group"><div className="flex items-center gap-3"><div className="text-blue-600 group-hover:text-blue-500"><Icon size={20} /></div><h2 className="font-bold text-slate-800 text-lg group-hover:text-blue-700 tracking-wide">{title}</h2></div>{isOpen ? <Icons.ChevronUp className="text-slate-400" /> : <Icons.ChevronDown className="text-slate-400" />}</button>
        );

        const InputField = ({ label, value, onChange, colorClass = "border-slate-200", icon: Icon }) => (
            <div className="relative group"><label className="block text-[10px] text-slate-500 font-bold uppercase mb-1 flex items-center gap-1">{Icon && <Icon size={10} />} {label}</label><input type="number" step="0.1" placeholder="-" value={value} onChange={(e) => onChange(e.target.value)} className={`w-full bg-slate-50 border rounded-lg px-3 py-2 font-mono text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-all text-slate-800 ${colorClass} ${value !== "" && value !== 0 ? 'text-blue-700 font-bold border-blue-400 bg-blue-50' : ''}`} /></div>
        );

        const InventoryRow = ({ item, onUpdate, onLinkBarcode, pendingBarcode, isWells, categoryName, onDelete }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            const isUnitBased = categoryName.includes("Beers") || categoryName.includes("Seltzer") || categoryName.includes("Non Alcoholic");
            const totalPhys = (parseFloat(item.bar1)||0) + (parseFloat(item.bar2)||0) + (parseFloat(item.bodega)||0) + (parseFloat(item.barroluco)||0);
            const totalStart = (parseFloat(item.start_bar1)||0) + (parseFloat(item.start_bar2)||0) + (parseFloat(item.start_bodega)||0) + (parseFloat(item.start_barroluco)||0);
            const purchases = parseFloat(item.purchases) || 0; const sales = parseFloat(item.sales) || 0;
            const systemConsumption = totalStart + purchases - totalPhys; const diff = sales - systemConsumption;
            const hasPhysical = item.bar1 || item.bar2 || item.bodega || item.barroluco; const hasStart = item.start_bar1 || item.start_bar2 || item.start_bodega || item.start_barroluco;
            const bottleSizeOz = isWells ? 33.814 : 25.36; 
            const handleSalesChange = (type, val) => {
                let newBottles = type === 'bottles' ? val : (item.sold_bottles || ""); let newShots = type === 'shots' ? val : (item.sold_shots || ""); let newComps = type === 'comps' ? val : (item.sold_comps || "");
                const b = parseFloat(newBottles) || 0; const s = parseFloat(newShots) || 0; const c = parseFloat(newComps) || 0;
                let totalSales = 0; if (isUnitBased) totalSales = b + (s * 6) + c; else totalSales = b + ((s * 1.2) / bottleSizeOz) + c;
                onUpdate(item.id, { sold_bottles: newBottles, sold_shots: newShots, sold_comps: newComps, sales: totalSales > 0 ? totalSales.toFixed(2) : "" });
            };
            
            let statusColor = "bg-white border-slate-200"; 
            let badgeClass = "text-slate-500 bg-slate-100 border border-slate-200";
            
            if (hasPhysical && hasStart) { 
                if (diff < -0.1) { 
                    statusColor = "bg-white border-red-200 shadow-sm"; 
                    badgeClass = "text-red-700 bg-red-50 border border-red-200 font-bold"; 
                } else if (diff > 0.1) { 
                    statusColor = "bg-white border-blue-200 shadow-sm"; 
                    badgeClass = "text-blue-700 bg-blue-50 border border-blue-200 font-bold"; 
                } else { 
                    statusColor = "bg-white border-emerald-200 shadow-sm"; 
                    badgeClass = "text-emerald-700 bg-emerald-50 border border-emerald-200 font-bold"; 
                } 
            }

            return (
                <div className={`rounded-xl border shadow-sm transition-all duration-300 overflow-hidden ${statusColor} mb-3 relative z-10`}>
                    <div className="p-4 flex justify-between items-center cursor-pointer hover:bg-slate-50 transition-colors" onClick={() => setIsExpanded(!isExpanded)}>
                        <div className="flex-1"><div className="flex items-center gap-2"><span className="font-bold text-slate-800 text-base">{item.name}</span>{(item.barcode || item.barcode_case) && <Icons.Barcode size={14} className="text-slate-400" />}{(hasPhysical && hasStart) ? <span className={`text-xs font-mono px-2 py-0.5 rounded ${badgeClass}`}>{diff > 0 ? "+" : ""}{diff.toFixed(1)}</span> : null}</div><div className="text-xs text-slate-500 mt-1 flex gap-3 font-mono"><span>Start: <b className="text-slate-700">{totalStart}</b></span><span className="text-slate-300">|</span><span>End: <b className="text-slate-700">{totalPhys}</b></span></div></div>
                        <div>{isExpanded ? <Icons.ChevronUp className="text-blue-600" /> : <Icons.ChevronDown className="text-slate-400" />}</div>
                    </div>
                    {isExpanded && (
                        <div className="p-4 border-t border-slate-100 bg-slate-50/50 space-y-4 animate-in relative">
                            <div className="relative z-10">
                                <div className="bg-white p-3 rounded-lg border border-slate-200 shadow-sm"><div className="flex items-center gap-2 mb-3 text-blue-600 font-bold text-[10px] uppercase tracking-widest"><Icons.Box size={12} /> 1. On Hand (Start)</div><div className="grid grid-cols-4 gap-2"><InputField label="Bar 1" value={item.start_bar1} onChange={(v) => onUpdate(item.id, 'start_bar1', v)} /><InputField label="Bar 2" value={item.start_bar2} onChange={(v) => onUpdate(item.id, 'start_bar2', v)} /><InputField label="Storage" value={item.start_bodega} onChange={(v) => onUpdate(item.id, 'start_bodega', v)} /><InputField label="Barroluco" value={item.start_barroluco} onChange={(v) => onUpdate(item.id, 'start_barroluco', v)} /></div></div>
                                <div className="bg-white p-3 rounded-lg border border-slate-200 mt-2"><div className="grid grid-cols-1 gap-3"><InputField label="2. Purchases (+)" value={item.purchases} onChange={(v) => onUpdate(item.id, 'purchases', v)} icon={Icons.ShoppingCart} colorClass="border-green-200 focus:border-green-500 text-green-700" /></div></div>
                                <div className="bg-white p-3 rounded-lg border border-slate-200 mt-2"><div className="flex items-center gap-2 mb-3 text-blue-600 font-bold text-[10px] uppercase tracking-widest"><Icons.MapPin size={12} /> 3. Physical Count (End)</div><div className="grid grid-cols-4 gap-2"><InputField label="Bar 1" value={item.bar1} onChange={(v) => onUpdate(item.id, 'bar1', v)} /><InputField label="Bar 2" value={item.bar2} onChange={(v) => onUpdate(item.id, 'bar2', v)} /><InputField label="Storage" value={item.bodega} onChange={(v) => onUpdate(item.id, 'bodega', v)} /><InputField label="Barroluco" value={item.barroluco} onChange={(v) => onUpdate(item.id, 'barroluco', v)} /></div></div>
                                <div className="bg-amber-50 p-3 rounded-lg border border-amber-200 mt-2 shadow-sm"><div className="flex items-center gap-2 mb-3 text-amber-700 font-bold text-[10px] uppercase tracking-widest"><Icons.Calculator size={12} /> 4. Sales Calculator (POS)</div><div className="mb-4 bg-white p-3 rounded border border-amber-100"><div className="text-[10px] text-amber-600 mb-1 uppercase font-bold tracking-wider">{isUnitBased ? "Unit Calculator" : `Shot Calculator`}</div><div className="grid grid-cols-3 gap-3 mb-2"><div className="relative group"><label className="block text-[10px] text-amber-600/70 font-bold uppercase mb-1">{isUnitBased ? "Cans / Units" : "Bottles"}</label><input type="number" step="1" placeholder="0" value={item.sold_bottles || ""} onChange={(e) => handleSalesChange('bottles', e.target.value)} className="w-full bg-slate-50 border border-amber-200 rounded-lg px-2 py-2 font-mono text-sm focus:outline-none focus:border-amber-500 text-amber-900" /></div><div className="relative group"><label className="block text-[10px] text-amber-600/70 font-bold uppercase mb-1">{isUnitBased ? "Buckets (x6)" : "Shots"}</label><input type="number" step="1" placeholder="0" value={item.sold_shots || ""} onChange={(e) => handleSalesChange('shots', e.target.value)} className="w-full bg-slate-50 border border-amber-200 rounded-lg px-2 py-2 font-mono text-sm focus:outline-none focus:border-amber-500 text-amber-900" /></div><div className="relative group"><label className="block text-[10px] text-amber-600/70 font-bold uppercase mb-1">{isUnitBased ? "Comps" : "Comps"}</label><input type="number" step="1" placeholder="0" value={item.sold_comps || ""} onChange={(e) => handleSalesChange('comps', e.target.value)} className="w-full bg-slate-50 border border-emerald-200 rounded-lg px-2 py-2 font-mono text-sm focus:outline-none focus:border-emerald-500 text-emerald-900" /></div></div></div><div className="grid grid-cols-1 gap-3"><InputField label="Total Sales POS (Calculated)" value={item.sales} onChange={(v) => onUpdate(item.id, 'sales', v)} icon={Icons.DollarSign} colorClass="border-blue-200 focus:border-blue-500 text-blue-700 shadow-sm" /></div><div className="text-right mt-4 text-xs text-slate-500 font-mono space-y-2"><div className="text-amber-700">Sys Sales = {totalStart} + {purchases || 0} - {totalPhys} = <b>{systemConsumption}</b></div><div className={`text-xl font-black ${diff < 0 ? 'text-red-600' : 'text-emerald-600'}`}>Diff = {diff.toFixed(2)}</div></div></div>
                                <div className="flex justify-between items-center pt-4 border-t border-slate-200 mt-2"><div className="text-[9px] text-slate-400 font-mono tracking-widest">ID: {item.id}</div><button onClick={(e) => { e.stopPropagation(); onDelete(item); }} className="flex items-center gap-2 bg-red-50 hover:bg-red-100 text-red-600 hover:text-red-700 border border-red-200 px-3 py-1.5 rounded-lg text-xs font-bold transition-all"><Icons.Trash size={14} /> Delete</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        // ESTA ES LA PARTE 3 DE 5

        const LoginScreen = ({ onLogin, logoSrc, onLogoUpload }) => {
            const [pin, setPin] = useState("");
            const [error, setError] = useState(false);

            const handleNum = (num) => {
                if (pin.length < 4) {
                    const newPin = pin + num;
                    setPin(newPin);
                    if (newPin.length === 4) {
                        setTimeout(() => {
                            if (newPin === "1130") { onLogin(); } else { setError(true); playSound('error'); setTimeout(() => { setPin(""); setError(false); }, 400); }
                        }, 200);
                    } else { playSound('add'); }
                }
            };

            const handleDelete = () => { if (pin.length > 0) { setPin(prev => prev.slice(0, -1)); playSound('sub'); } };

            return (
                <div className="fixed inset-0 bg-slate-50 flex flex-col items-center justify-center p-4 z-[9999]">
                    <div className="mb-10 text-center animate-in flex flex-col items-center">
                        <div 
                            className="w-32 h-32 bg-white rounded-full mb-6 flex items-center justify-center border border-slate-200 shadow-xl relative overflow-hidden group cursor-pointer hover:border-blue-500 transition-all"
                            onClick={() => document.getElementById('login-logo-upload').click()}
                        >
                            {logoSrc ? (
                                <img src={logoSrc} alt="Logo" className="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity" />
                            ) : (
                                <Icons.GlassWater size={48} className="text-blue-500" />
                            )}
                        </div>
                        <input type="file" id="login-logo-upload" accept="image/*" className="hidden" onChange={onLogoUpload} />
                        <h1 className="text-4xl font-black text-slate-800 mb-2 tracking-tight">MASTER CONTROL</h1>
                        <p className="text-slate-400 text-[10px] font-bold uppercase tracking-[0.3em] border-t border-slate-200 pt-2 w-full">System Access v{APP_VERSION}</p>
                    </div>

                    <div className={`flex gap-6 mb-12 ${error ? 'shake' : ''}`}>
                        {[0, 1, 2, 3].map(i => (
                            <div key={i} className={`w-3 h-3 rounded-full transition-all duration-300 ${pin.length > i ? (error ? 'bg-red-500' : 'bg-blue-500 scale-125') : 'bg-slate-200'}`}></div>
                        ))}
                    </div>

                    <div className="grid grid-cols-3 gap-6 max-w-xs w-full">
                        {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => (
                            <button key={num} onClick={() => handleNum(num.toString())} className="h-16 w-16 rounded-xl text-2xl font-bold text-slate-700 bg-white hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 hover:shadow-lg active:scale-95 transition-all border border-slate-200 flex items-center justify-center mx-auto shadow-sm">{num}</button>
                        ))}
                        <div className="h-16 w-16"></div>
                        <button onClick={() => handleNum("0")} className="h-16 w-16 rounded-xl text-2xl font-bold text-slate-700 bg-white hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 hover:shadow-lg active:scale-95 transition-all border border-slate-200 flex items-center justify-center mx-auto shadow-sm">0</button>
                        <button onClick={handleDelete} className="h-16 w-16 flex items-center justify-center text-slate-400 hover:text-red-500 active:scale-90 transition-all mx-auto hover:bg-red-50 rounded-xl"><span className="text-xl font-bold">‚úï</span></button>
                    </div>
                </div>
            );
        };

        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message, isDestructive, customActions }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 p-4 backdrop-blur-sm animate-in">
                    <div className="bg-white border border-slate-200 rounded-2xl max-w-md w-full p-8 shadow-2xl relative overflow-hidden">
                        <div className={`absolute top-0 left-0 w-full h-1 ${isDestructive ? 'bg-red-500' : 'bg-blue-500'}`}></div>
                        <h3 className="text-2xl font-bold text-slate-800 mb-2 flex items-center gap-3">
                            {isDestructive ? <Icons.AlertTriangle className="text-red-500" size={28} /> : <Icons.CheckCircle className="text-blue-500" size={28} />}
                            {title}
                        </h3>
                        <p className="text-slate-600 mb-8 font-medium">{message}</p>
                        {customActions ? (
                            <div className="flex flex-col gap-3">
                                {customActions.map((action, idx) => (
                                    <button key={idx} onClick={action.onClick} className={`w-full py-4 rounded-xl font-bold transition-all shadow-sm active:scale-95 text-sm tracking-wide uppercase ${action.class}`}>{action.label}</button>
                                ))}
                                <button onClick={onClose} className="w-full py-3 mt-2 text-slate-400 hover:text-slate-600 text-xs font-bold uppercase tracking-widest transition-colors">Cancel Operation</button>
                            </div>
                        ) : (
                            <div className="flex justify-end gap-3">
                                <button onClick={onClose} className="px-6 py-3 rounded-xl bg-slate-100 text-slate-600 hover:bg-slate-200 font-bold text-xs uppercase tracking-wider">Cancel</button>
                                <button onClick={onConfirm} className={`px-6 py-3 rounded-xl text-white font-bold shadow-md text-xs uppercase tracking-wider ${isDestructive ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'}`}>Confirm</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ImportModal = ({ isOpen, onClose, onReplace, onMerge }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-[70] backdrop-blur-sm animate-in p-4">
                    <div className="bg-white border border-slate-200 w-full max-w-md rounded-3xl shadow-2xl p-8 relative">
                        <div className="absolute top-0 right-0 p-4 opacity-5 pointer-events-none"><Icons.Cloud size={100} className="text-blue-900" /></div>
                        <h2 className="text-2xl font-black text-slate-800 mb-2 flex items-center gap-3 relative z-10"><Icons.Upload className="text-blue-600" /> Import Data</h2>
                        <p className="text-slate-500 mb-8 text-sm relative z-10 font-medium">Select integration method for external file:</p>
                        <div className="flex flex-col gap-4 relative z-10">
                            <button onClick={onMerge} className="flex items-center justify-between p-5 bg-blue-50 border border-blue-100 rounded-2xl hover:bg-blue-100 transition-all group text-left">
                                <div><div className="font-bold text-blue-800 uppercase tracking-wide text-sm">Merge Data</div><div className="text-[10px] text-blue-600/70 mt-1">Sums existing quantities with file.</div></div>
                                <Icons.GitMerge className="text-blue-500" />
                            </button>
                            <button onClick={onReplace} className="flex items-center justify-between p-5 bg-red-50 border border-red-100 rounded-2xl hover:bg-red-100 transition-all group text-left">
                                <div><div className="font-bold text-red-800 uppercase tracking-wide text-sm">Replace All</div><div className="text-[10px] text-red-600/70 mt-1">DANGER: Overwrites current system data.</div></div>
                                <Icons.Trash className="text-red-500" />
                            </button>
                        </div>
                        <button onClick={onClose} className="w-full mt-8 py-3 rounded-xl border border-slate-200 text-slate-400 font-bold uppercase text-[10px] tracking-widest hover:text-slate-600 hover:bg-slate-50 transition-all">Cancel Import</button>
                    </div>
                </div>
            );
        };

        const AddProductModal = ({ isOpen, onClose, onAdd, categories }) => {
            if (!isOpen) return null;
            const [name, setName] = useState("");
            const [category, setCategory] = useState(categories[0] || "");
            const handleSubmit = () => { if (!name.trim()) return; onAdd(name, category); setName(""); onClose(); };
            return (
                <div className="fixed inset-0 bg-slate-900/50 flex flex-col items-center justify-center z-[60] backdrop-blur-sm animate-in p-4">
                    <div className="bg-white border border-slate-200 w-full max-w-md rounded-3xl shadow-2xl p-8">
                        <h2 className="text-2xl font-black text-slate-800 mb-6 flex items-center gap-3"><Icons.Plus className="text-blue-500" /> New SKU Entry</h2>
                        <div className="space-y-6">
                            <div><label className="block text-[10px] text-slate-500 font-bold uppercase mb-2 tracking-widest">Product Name</label><input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-4 text-slate-900 focus:outline-none focus:border-blue-500 font-bold text-lg" placeholder="e.g., VODKA" autoFocus/></div>
                            <div><label className="block text-[10px] text-slate-500 font-bold uppercase mb-2 tracking-widest">Category</label><select value={category} onChange={(e) => setCategory(e.target.value)} className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-4 text-slate-900 focus:outline-none focus:border-blue-500 font-bold appearance-none">{categories.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                        </div>
                        <div className="flex gap-4 mt-8"><button onClick={onClose} className="flex-1 py-4 rounded-xl bg-slate-100 text-slate-500 font-bold hover:bg-slate-200 uppercase text-xs tracking-wider transition-all">Cancel</button><button onClick={handleSubmit} className="flex-1 py-4 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg uppercase text-xs tracking-wider transition-all">Confirm Add</button></div>
                    </div>
                </div>
            );
        };

        const ShoppingListModal = ({ isOpen, onClose, items }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-white flex flex-col z-50 animate-in overflow-hidden">
                    <div className="p-6 border-b border-slate-200 flex justify-between items-center bg-white">
                        <h2 className="text-2xl font-black text-slate-800 flex items-center gap-3"><Icons.ShoppingCart className="text-amber-500" /> PROCUREMENT</h2>
                        <button onClick={onClose} className="px-4 py-2 bg-slate-100 text-slate-500 hover:text-slate-800 rounded-lg hover:bg-slate-200 text-xs font-bold uppercase tracking-wider transition-all">Close</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                        {items.length === 0 ? <div className="text-center text-slate-300 mt-32 flex flex-col items-center"><Icons.CheckCircle size={64} className="mb-4 opacity-50" /><p className="text-xl font-medium uppercase tracking-widest">Stock Optimal</p></div> : <div className="grid gap-3">{items.map((item, idx) => (<div key={idx} className="bg-white p-5 rounded-2xl border border-slate-200 flex justify-between items-center shadow-sm hover:border-amber-300 transition-all group"><div><h3 className="font-bold text-slate-800 text-lg tracking-wide">{item.name}</h3><div className="text-[10px] text-slate-500 font-mono mt-2 uppercase tracking-widest">Stock: <span className="text-emerald-600 font-bold">{item.current}</span> <span className="mx-2 text-slate-300">|</span> Target: <span className="text-blue-600 font-bold">{item.target}</span></div></div><div className="text-right bg-amber-50 px-4 py-2 rounded-xl border border-amber-100"><div className="text-[9px] text-amber-600 uppercase font-bold tracking-widest mb-1">Acquire</div><div className="text-2xl font-black text-amber-500">{item.needed}</div>{item.details && <div className="text-[9px] text-slate-400 font-mono mt-1">{item.details}</div>}</div></div>))}</div>}
                    </div>
                </div>
            );
        };
        
        const CountReviewModal = ({ isOpen, onClose, data, onUpdate }) => {
            if (!isOpen) return null;
            const mainLocations = [
                { id: 'bar1', label: 'Bar 1', color: 'text-blue-600', bg: 'bg-blue-50', border: 'border-blue-200' },
                { id: 'bar2', label: 'Bar 2', color: 'text-purple-600', bg: 'bg-purple-50', border: 'border-purple-200' },
                { id: 'bodega', label: 'Storage', color: 'text-amber-600', bg: 'bg-amber-50', border: 'border-amber-200' },
                { id: 'barroluco', label: 'Barroluco', color: 'text-pink-600', bg: 'bg-pink-50', border: 'border-pink-200' }
            ];
            const getItemsForField = (fieldId) => { const found = []; data.forEach(cat => { cat.items.forEach(item => { const val = parseFloat(item[fieldId]); if (!isNaN(val) && val > 0) { found.push({ ...item, currentVal: val }); } }); }); return found; };
            const grandTotal = data.reduce((acc, cat) => { return acc + cat.items.reduce((iAcc, item) => { const t = (parseFloat(item.bar1)||0) + (parseFloat(item.bar2)||0) + (parseFloat(item.bodega)||0) + (parseFloat(item.barroluco)||0); return iAcc + t; }, 0); }, 0);
            return (
                <div className="fixed inset-0 bg-white flex flex-col z-[100] animate-in">
                    <div className="p-6 border-b border-slate-200 flex justify-between items-center bg-white shadow-sm z-20">
                        <div><h2 className="text-2xl font-black text-slate-800 flex items-center gap-3"><Icons.List className="text-emerald-500" /> SYSTEM AUDIT</h2><p className="text-[10px] text-slate-400 font-mono mt-1 uppercase tracking-widest">Total Physical Count: <span className="text-slate-800 font-bold">{grandTotal}</span></p></div>
                        <button onClick={onClose} className="px-6 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 font-bold text-xs uppercase tracking-widest transition-all">Close</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 space-y-8 bg-slate-50">{mainLocations.map(mainLoc => { const subZones = ZONES_CONFIG[mainLoc.id]; if (subZones) { const zonesWithData = subZones.map(z => ({...z, items: getItemsForField(z.id)})).filter(z => z.items.length > 0); if (zonesWithData.length === 0) return null; return (<div key={mainLoc.id} className="space-y-4"><div className={`sticky top-0 z-10 px-4 py-3 rounded-xl border shadow-sm ${mainLoc.bg} ${mainLoc.border}`}><h3 className={`font-black text-sm uppercase tracking-[0.2em] ${mainLoc.color}`}>{mainLoc.label}</h3></div>{zonesWithData.map(zone => (<div key={zone.id} className="pl-4 border-l-2 border-slate-200 ml-2"><h4 className="text-xs font-bold text-slate-500 mb-3 flex items-center gap-2 px-2 uppercase tracking-wider"><span className="text-lg opacity-80">{zone.icon}</span> {zone.label}</h4><div className="grid gap-2">{zone.items.map(item => (<div key={item.id} className="bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center shadow-sm hover:border-blue-300 transition-all group"><div className="font-bold text-slate-800">{item.name}</div><div className="flex items-center gap-2 bg-slate-50 rounded-lg px-3 py-1 border border-slate-200"><span className="text-[9px] text-slate-400 uppercase font-bold tracking-wider">Qty</span><input type="number" value={item.currentVal} onChange={(e) => { const val = parseFloat(e.target.value) || 0; let newTotal = val; subZones.forEach(z => { if (z.id !== zone.id) { newTotal += (parseFloat(item[z.id]) || 0); } }); onUpdate(item.id, { [zone.id]: val, [mainLoc.id]: newTotal }); }} className="w-16 bg-transparent text-right font-mono font-bold text-blue-600 focus:outline-none" /></div></div>))}</div></div>))}</div>); } else { const items = getItemsForField(mainLoc.id); if (items.length === 0) return null; return (<div key={mainLoc.id} className="space-y-4"><div className={`sticky top-0 z-10 px-4 py-3 rounded-xl border shadow-sm ${mainLoc.bg} ${mainLoc.border}`}><h3 className={`font-black text-sm uppercase tracking-[0.2em] ${mainLoc.color}`}>{mainLoc.label}</h3></div><div className="grid gap-2">{items.map(item => (<div key={item.id} className="bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center shadow-sm hover:border-blue-300 transition-all group"><div className="font-bold text-slate-800">{item.name}</div><div className="flex items-center gap-2 bg-slate-50 rounded-lg px-3 py-1 border border-slate-200"><span className="text-[9px] text-slate-400 uppercase font-bold tracking-wider">Qty</span><input type="number" value={item.currentVal} onChange={(e) => onUpdate(item.id, mainLoc.id, e.target.value)} className="w-16 bg-transparent text-right font-mono font-bold text-blue-600 focus:outline-none" /></div></div>))}</div></div>); } })} {grandTotal === 0 && (<div className="text-center text-slate-300 py-32 flex flex-col items-center"><Icons.List size={80} className="mb-6 opacity-30" /><p className="text-xl font-medium uppercase tracking-widest">No data recorded</p></div>)}</div></div>);
        };

        const ChartsView = ({ data, onClose }) => {
            const canvasRef = useRef(null);
            const chartInstance = useRef(null);
            const { activeItems, totals, categoryData } = useMemo(() => {
                let items = []; let totalConsumed = 0; let totalSold = 0; let totalDiff = 0; let catMap = {};
                data.forEach(cat => {
                    let catSales = 0; 
                    cat.items.forEach(item => {
                        const totalPhys = (parseFloat(item.bar1)||0) + (parseFloat(item.bar2)||0) + (parseFloat(item.bodega)||0) + (parseFloat(item.barroluco)||0);
                        const totalStart = (parseFloat(item.start_bar1)||0) + (parseFloat(item.start_bar2)||0) + (parseFloat(item.start_bodega)||0) + (parseFloat(item.start_barroluco)||0);
                        const purchases = parseFloat(item.purchases)||0; const sales = parseFloat(item.sales)||0;
                        const systemConsumption = totalStart + purchases - totalPhys;
                        const diff = sales - systemConsumption;
                        if (systemConsumption > 0 || sales > 0) {
                            items.push({ ...item, systemConsumption, sales, diff });
                            totalConsumed += systemConsumption; totalSold += sales; totalDiff += diff; catSales += sales;
                        }
                    });
                    if (catSales > 0) catMap[cat.category] = catSales;
                });
                return { activeItems: items.sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff)), totals: { totalConsumed, totalSold, totalDiff }, categoryData: catMap };
            }, [data]);

            useEffect(() => {
                if (canvasRef.current && window.Chart) {
                    if (chartInstance.current) chartInstance.current.destroy();
                    const ctx = canvasRef.current.getContext('2d');
                    chartInstance.current = new window.Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(categoryData), datasets: [{ data: Object.values(categoryData), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6', '#6366f1', '#ef4444'], borderColor: '#ffffff', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, layout: { padding: 20 }, plugins: { legend: { position: 'right', labels: { color: '#334155', font: { size: 11, family: 'Inter' }, boxWidth: 10, padding: 15 } } } } });
                }
                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [categoryData]);

            return (
                <div className="fixed inset-0 bg-white flex flex-col z-50 animate-in overflow-hidden">
                    <div className="p-6 border-b border-slate-200 flex justify-between items-center bg-white">
                        <h2 className="text-2xl font-black text-slate-800 flex items-center gap-4"><div className="p-2 bg-indigo-50 rounded-xl border border-indigo-100 text-indigo-600"><Icons.BarChart size={24} /></div>ANALYTICS</h2>
                        <button onClick={onClose} className="px-6 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 transition-all text-xs font-bold uppercase tracking-widest">Exit</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 space-y-8 bg-slate-50">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="space-y-4 flex flex-col">
                                <div className="flex-1 bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col justify-center relative overflow-hidden group">
                                    <div className="text-[10px] text-slate-400 uppercase font-bold tracking-[0.2em] mb-2">Total Consumed</div>
                                    <div className="text-5xl font-black text-slate-800 tracking-tighter">{totals.totalConsumed.toFixed(1)}</div>
                                </div>
                                <div className="flex-1 bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col justify-center relative overflow-hidden group">
                                    <div className="text-[10px] text-indigo-400 uppercase font-bold tracking-[0.2em] mb-2">Total Sales (POS)</div>
                                    <div className="text-5xl font-black text-indigo-600 tracking-tighter">{totals.totalSold.toFixed(1)}</div>
                                </div>
                                <div className={`flex-1 p-6 rounded-3xl border shadow-sm flex flex-col justify-center relative overflow-hidden ${totals.totalDiff < 0 ? 'border-red-200 bg-red-50' : 'border-emerald-200 bg-emerald-50'}`}>
                                    <div className={`text-[10px] uppercase font-bold tracking-[0.2em] mb-2 ${totals.totalDiff < 0 ? 'text-red-500' : 'text-emerald-500'}`}>Net Variance</div>
                                    <div className={`text-5xl font-black tracking-tighter ${totals.totalDiff < 0 ? 'text-red-600' : 'text-emerald-600'}`}>{totals.totalDiff > 0 ? '+' : ''}{totals.totalDiff.toFixed(1)}</div>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm min-h-[300px] relative flex flex-col"><div className="absolute top-6 left-6 text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] z-10">Sales Distribution</div><div className="flex-1 relative mt-4"><canvas ref={canvasRef}></canvas></div></div>
                        </div>
                        <div className="space-y-4"><h3 className="text-[10px] font-bold text-slate-400 uppercase tracking-[0.3em] px-2 mt-8">Variance Breakdown</h3>{activeItems.map(item => (<div key={item.id} className="bg-white border border-slate-200 p-6 rounded-2xl relative overflow-hidden shadow-sm"><div className="flex justify-between items-start relative z-10"><div><div className="font-bold text-slate-800 text-lg">{item.name}</div><div className="text-[9px] text-slate-400 font-mono mt-1 uppercase tracking-widest">ID: {item.id}</div></div><div className={`px-4 py-2 rounded-xl text-lg font-black font-mono border min-w-[80px] text-center ${item.diff < -0.1 ? 'bg-red-50 text-red-600 border-red-200' : item.diff > 0.1 ? 'bg-blue-50 text-blue-600 border-blue-200' : 'bg-slate-50 text-slate-400 border-slate-200'}`}>{item.diff > 0 ? '+' : ''}{item.diff.toFixed(2)}</div></div></div>))}</div>
                    </div>
                </div>
            );
        };

        const PurchasesLogModal = ({ isOpen, onClose, data }) => {
            if (!isOpen) return null;
            const purchasedItems = []; let totalPurchasedUnits = 0;
            data.forEach(cat => { cat.items.forEach(item => { const val = parseFloat(item.purchases); if (!isNaN(val) && val > 0) { purchasedItems.push({ ...item, categoryName: cat.category, purchaseVal: val }); totalPurchasedUnits += val; } }); });
            return (
                <div className="fixed inset-0 bg-white flex flex-col z-[80] animate-in overflow-hidden">
                    <div className="p-6 border-b border-slate-200 flex justify-between items-center bg-white">
                        <h2 className="text-2xl font-black text-slate-800 flex items-center gap-3"><Icons.Package className="text-emerald-500" /> INBOUND LOG</h2>
                        <button onClick={onClose} className="px-6 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 font-bold text-xs uppercase tracking-widest border border-slate-200 transition-all">Close</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                        {purchasedItems.length === 0 ? <div className="text-center text-slate-300 mt-32 flex flex-col items-center"><Icons.Package size={80} className="mb-6 opacity-30" /><p className="text-xl font-medium uppercase tracking-widest">No inbound stock</p></div> : <div className="space-y-6"><div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm"><div className="text-[10px] text-slate-400 uppercase font-bold tracking-[0.2em] mb-2">Total Units Added</div><div className="text-5xl font-black text-emerald-600">{totalPurchasedUnits}</div></div><div className="grid gap-3">{purchasedItems.map((item, idx) => (<div key={idx} className="bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center hover:border-emerald-300 transition-all group"><div><div className="font-bold text-slate-800 text-lg tracking-wide">{item.name}</div><div className="text-[9px] text-slate-400 uppercase tracking-widest mt-1">{item.categoryName}</div></div><div className="text-emerald-600 font-mono font-black text-2xl">+{item.purchaseVal}</div></div>))}</div></div>}
                    </div>
                </div>
            );
        };

        const BottleSpecsModal = ({ isOpen, onClose, data, onUpdate }) => {
            if (!isOpen) return null;
            const [searchTerm, setSearchTerm] = useState("");
            const [localWeights, setLocalWeights] = useState({});

            const handleWeightChange = (itemId, type, val) => {
                setLocalWeights(prev => ({ ...prev, [itemId]: { ...prev[itemId], [type]: val } }));
            };

            const saveWeight = (item) => {
                const weights = localWeights[item.id];
                if (weights) {
                    if (weights.empty !== undefined) onUpdate(item.id, 'weight_empty', weights.empty);
                    if (weights.full !== undefined) onUpdate(item.id, 'weight_full', weights.full);
                    playSound('success');
                }
            };

            const filteredAllItems = [];
            data.forEach(cat => {
                cat.items.forEach(item => {
                    if (item.name.toLowerCase().includes(searchTerm.toLowerCase())) {
                        filteredAllItems.push({ ...item, category: cat.category });
                    }
                });
            });

            return (
                <div className="fixed inset-0 bg-white flex flex-col z-[90] animate-in overflow-hidden">
                    <div className="p-6 border-b border-slate-200 flex justify-between items-center bg-white">
                        <div><h2 className="text-2xl font-black text-slate-800 flex items-center gap-3"><Icons.Settings className="text-indigo-500" /> BOTTLE SPECS</h2><p className="text-[10px] text-slate-400 uppercase tracking-widest mt-1">Weight Configuration (Grams)</p></div>
                        <button onClick={onClose} className="px-6 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 font-bold text-xs uppercase tracking-widest border border-slate-200 transition-all">Exit</button>
                    </div>
                    <div className="p-4 bg-slate-50 border-b border-slate-200">
                        <div className="relative"><Icons.Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                        <input type="text" placeholder="SEARCH DATABASE..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full bg-white border border-slate-200 rounded-xl pl-12 pr-4 py-4 text-slate-800 focus:outline-none focus:border-indigo-500 transition-all font-bold text-sm shadow-sm" /></div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 space-y-3 bg-slate-50">
                        {filteredAllItems.map(item => (
                            <div key={item.id} className="bg-white border border-slate-200 rounded-xl p-4 shadow-sm flex justify-between items-center hover:border-indigo-300 transition-all">
                                <div className="flex-1">
                                    <div className="font-bold text-slate-800 text-base">{item.name}</div>
                                    <div className="text-[10px] text-slate-400 uppercase tracking-widest mt-1">{item.category}</div>
                                </div>
                                <div className="flex gap-4 items-center">
                                    <div className="flex flex-col gap-1">
                                        <label className="text-[9px] text-indigo-500 font-bold uppercase tracking-widest">Empty (g)</label>
                                        <input type="number" placeholder="-" className="w-20 bg-slate-50 border border-slate-200 rounded-lg px-2 py-2 text-center text-slate-800 font-mono text-sm focus:border-indigo-500 outline-none" 
                                            value={localWeights[item.id]?.empty !== undefined ? localWeights[item.id].empty : (item.weight_empty || "")} 
                                            onChange={(e) => handleWeightChange(item.id, 'empty', e.target.value)} 
                                        />
                                    </div>
                                    <div className="flex flex-col gap-1">
                                        <label className="text-[9px] text-indigo-500 font-bold uppercase tracking-widest">Full (g)</label>
                                        <input type="number" placeholder="-" className="w-20 bg-slate-50 border border-slate-200 rounded-lg px-2 py-2 text-center text-slate-800 font-mono text-sm focus:border-indigo-500 outline-none" 
                                            value={localWeights[item.id]?.full !== undefined ? localWeights[item.id].full : (item.weight_full || "")} 
                                            onChange={(e) => handleWeightChange(item.id, 'full', e.target.value)} 
                                        />
                                    </div>
                                    <button onClick={() => saveWeight(item)} className="h-10 w-10 flex items-center justify-center bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded-xl border border-indigo-200 transition-all active:scale-95"><Icons.Save size={18} /></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        // ESTA ES LA PARTE 4 DE 5

        const SalesEntryModal = ({ isOpen, onClose, data, onUpdate, onBatchUpdate }) => {
            if (!isOpen) return null;
            const [searchTerm, setSearchTerm] = useState("");
            const [activeTab, setActiveTab] = useState('products'); 
            
            const filteredData = useMemo(() => {
                if (!searchTerm) return data;
                const lowerTerm = searchTerm.toLowerCase();
                return data.map(cat => ({ ...cat, items: cat.items.filter(item => item.name.toLowerCase().includes(lowerTerm)) })).filter(cat => cat.items.length > 0);
            }, [data, searchTerm]);

            const filteredCocktails = useMemo(() => {
                if (!searchTerm) return COCKTAIL_RECIPES;
                const lowerTerm = searchTerm.toLowerCase();
                return COCKTAIL_RECIPES.filter(c => c.name.toLowerCase().includes(lowerTerm));
            }, [searchTerm]);

            const filteredPitchers = useMemo(() => {
                if (!searchTerm) return PITCHER_RECIPES;
                const lowerTerm = searchTerm.toLowerCase();
                return PITCHER_RECIPES.filter(c => c.name.toLowerCase().includes(lowerTerm));
            }, [searchTerm]);

            const handleLocalSalesChange = (item, type, val, categoryName) => {
                let newBottles = type === 'bottles' ? val : (item.sold_bottles || ""); 
                let newShots = type === 'shots' ? val : (item.sold_shots || ""); 
                let newComps = type === 'comps' ? val : (item.sold_comps || "");
                const b = parseFloat(newBottles) || 0; const s = parseFloat(newShots) || 0; const c = parseFloat(newComps) || 0;
                const isUnitBased = categoryName.includes("Beers") || categoryName.includes("Seltzer") || categoryName.includes("Non Alcoholic");
                const isWells = categoryName.includes("Wells");
                const bottleSizeOz = isWells ? 33.814 : 25.36;
                let totalSales = 0; if (isUnitBased) totalSales = b + (s * 6) + c; else totalSales = b + ((s * 1.2) / bottleSizeOz) + c;
                onUpdate(item.id, { sold_bottles: newBottles, sold_shots: newShots, sold_comps: newComps, sales: totalSales > 0 ? totalSales.toFixed(2) : "" });
            };

            const [recipeQuantities, setRecipeQuantities] = useState({});

            const handleRecipeQtyChange = (name, val) => {
                setRecipeQuantities(prev => ({...prev, [name]: val}));
            };

            const handleAddRecipe = (recipe) => {
                const qtyToAdd = parseInt(recipeQuantities[recipe.name] || 1);
                if (qtyToAdd <= 0) return;

                const updates = [];
                let foundAny = false;

                recipe.ingredients.forEach(ing => {
                    for (const cat of data) {
                        const item = cat.items.find(i => i.name === ing.name);
                        if (item) {
                            foundAny = true;
                            const currentShots = parseFloat(item.sold_shots) || 0;
                            const addedShots = ing.qty * qtyToAdd;
                            const newShots = currentShots + addedShots;
                            
                            const isWells = cat.category.includes("Wells");
                            const bottleSizeOz = isWells ? 33.814 : 25.36;
                            const b = parseFloat(item.sold_bottles) || 0;
                            const c = parseFloat(item.sold_comps) || 0;
                            const totalSales = b + ((newShots * 1.2) / bottleSizeOz) + c;

                            const existingUpdateIndex = updates.findIndex(u => u.id === item.id);
                            if (existingUpdateIndex >= 0) {
                                updates[existingUpdateIndex].changes.sold_shots += addedShots;
                                const combinedShots = updates[existingUpdateIndex].changes.sold_shots;
                                const combinedSales = b + ((combinedShots * 1.2) / bottleSizeOz) + c;
                                updates[existingUpdateIndex].changes.sales = combinedSales > 0 ? combinedSales.toFixed(2) : "";
                            } else {
                                updates.push({
                                    id: item.id,
                                    changes: { sold_shots: newShots, sales: totalSales > 0 ? totalSales.toFixed(2) : "" }
                                });
                            }
                            break; 
                        }
                    }
                });
                
                if (updates.length > 0) {
                    onBatchUpdate(updates);
                    setRecipeQuantities(prev => ({...prev, [recipe.name]: ""}));
                }
            };

            const renderRecipeList = (list) => (
                <div className="grid gap-3">
                    {list.map((recipe, idx) => (
                        <div key={idx} className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex justify-between items-center hover:border-blue-300 transition-all group">
                            <div className="flex-1 mr-4">
                                <h3 className="font-bold text-slate-800 text-base">{recipe.name}</h3>
                                <div className="text-xs text-slate-500 mt-1 font-mono">{recipe.ingredients.map(ing => `${ing.qty} ${ing.name}`).join(', ')}</div>
                            </div>
                            <div className="flex items-center gap-2">
                                <input 
                                    type="number" 
                                    min="1"
                                    placeholder="1" 
                                    className="w-14 bg-slate-50 border border-slate-200 rounded-lg px-2 py-2 text-center text-slate-800 font-mono text-sm focus:border-blue-500 outline-none"
                                    value={recipeQuantities[recipe.name] || ""}
                                    onChange={(e) => handleRecipeQtyChange(recipe.name, e.target.value)}
                                />
                                <button 
                                    onClick={(e) => { 
                                        handleAddRecipe(recipe); 
                                        const btn = e.currentTarget; 
                                        btn.innerHTML = "‚úî"; 
                                        btn.classList.add("bg-emerald-600", "text-white"); 
                                        setTimeout(() => { 
                                            btn.innerHTML = "Add"; 
                                            btn.classList.remove("bg-emerald-600", "text-white"); 
                                        }, 1000); 
                                    }} 
                                    className="px-5 py-2 bg-slate-100 border border-slate-200 text-slate-600 hover:bg-blue-600 hover:text-white rounded-lg font-bold text-sm transition-all active:scale-95 shadow-sm whitespace-nowrap uppercase tracking-wider"
                                >
                                    Add
                                </button>
                            </div>
                        </div>
                    ))}
                    {list.length === 0 && <div className="text-center text-slate-400 mt-10 uppercase tracking-widest">No recipes found.</div>}
                </div>
            );

            return (
                <div className="fixed inset-0 bg-white flex flex-col z-[85] animate-in overflow-hidden">
                    <div className="p-6 border-b border-slate-200 flex justify-between items-center bg-white">
                        <h2 className="text-2xl font-black text-slate-800 flex items-center gap-3"><Icons.DollarSign className="text-emerald-500" /> POS CALCULATOR</h2>
                        <button onClick={onClose} className="px-6 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 font-bold text-xs uppercase tracking-widest border border-slate-200 transition-all">Exit</button>
                    </div>
                    <div className="p-4 border-b border-slate-200 bg-slate-50 space-y-4">
                        <div className="flex p-1 bg-slate-200 rounded-xl border border-slate-300">
                            <button onClick={() => setActiveTab('products')} className={`flex-1 py-3 rounded-lg text-xs font-black uppercase tracking-widest transition-all ${activeTab === 'products' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-800'}`}>Products</button>
                            <button onClick={() => setActiveTab('cocktails')} className={`flex-1 py-3 rounded-lg text-xs font-black uppercase tracking-widest transition-all flex items-center justify-center gap-2 ${activeTab === 'cocktails' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-800'}`}><Icons.Cocktail size={14} /> Cocktails</button>
                            <button onClick={() => setActiveTab('pitchers')} className={`flex-1 py-3 rounded-lg text-xs font-black uppercase tracking-widest transition-all flex items-center justify-center gap-2 ${activeTab === 'pitchers' ? 'bg-white text-amber-600 shadow-sm' : 'text-slate-500 hover:text-slate-800'}`}><Icons.Pitcher size={14} /> Pitchers</button>
                        </div>
                        <div className="relative"><Icons.Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={18} /><input type="text" placeholder={`SEARCH ${activeTab.toUpperCase()}...`} className="w-full bg-white border border-slate-200 rounded-xl pl-12 pr-4 py-4 text-slate-800 focus:outline-none focus:border-blue-500 transition-all font-bold text-sm shadow-sm" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />{searchTerm && <button onClick={() => setSearchTerm("")} className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600">‚úï</button>}</div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 space-y-8 bg-slate-50">
                        {activeTab === 'products' ? (
                            filteredData.length === 0 ? <div className="text-center text-slate-400 mt-10 uppercase tracking-widest">No products found.</div> : filteredData.map(cat => (
                                <div key={cat.category} className="space-y-4">
                                    <div className="sticky top-0 bg-slate-50/95 backdrop-blur-sm py-3 z-10 border-b border-slate-200 flex items-center gap-2">
                                        <div className="w-1 h-4 bg-blue-500 rounded-full"></div>
                                        <h3 className="text-blue-600 font-black text-sm uppercase tracking-[0.2em]">{cat.category}</h3>
                                    </div>
                                    <div className="grid gap-3">{cat.items.map(item => {
                                        const isUnit = cat.category.includes("Beers") || cat.category.includes("Seltzer") || cat.category.includes("Non");
                                        return (
                                            <div key={item.id} className="bg-white p-4 rounded-xl border border-slate-200 flex flex-col gap-3 shadow-sm hover:border-blue-300 transition-all">
                                                <div className="flex justify-between items-center"><span className="font-bold text-slate-800 text-sm tracking-wide">{item.name}</span><span className="text-emerald-600 font-mono font-bold text-xs bg-emerald-50 px-3 py-1 rounded border border-emerald-100">Total: {item.sales || 0}</span></div>
                                                <div className="grid grid-cols-3 gap-3">
                                                    <div className="relative"><label className="text-[9px] text-slate-400 uppercase font-bold block mb-1 tracking-widest">{isUnit ? 'Units' : 'Btls'}</label><input type="number" placeholder="0" className="w-full bg-slate-50 border border-slate-200 rounded-lg px-2 py-2 text-center text-slate-800 font-mono text-sm focus:border-blue-500 outline-none" value={item.sold_bottles || ""} onChange={(e) => handleLocalSalesChange(item, 'bottles', e.target.value, cat.category)}/></div>
                                                    <div className="relative"><label className="text-[9px] text-slate-400 uppercase font-bold block mb-1 tracking-widest">{isUnit ? 'Bkt(x6)' : 'Shots'}</label><input type="number" placeholder="0" className="w-full bg-slate-50 border border-slate-200 rounded-lg px-2 py-2 text-center text-slate-800 font-mono text-sm focus:border-blue-500 outline-none" value={item.sold_shots || ""} onChange={(e) => handleLocalSalesChange(item, 'shots', e.target.value, cat.category)}/></div>
                                                    <div className="relative"><label className="text-[9px] text-slate-400 uppercase font-bold block mb-1 tracking-widest">Comps</label><input type="number" placeholder="0" className="w-full bg-slate-50 border border-emerald-200 rounded-lg px-2 py-2 text-center text-emerald-800 font-mono text-sm focus:border-emerald-500 outline-none" value={item.sold_comps || ""} onChange={(e) => handleLocalSalesChange(item, 'comps', e.target.value, cat.category)}/></div>
                                                </div>
                                            </div>
                                        );
                                    })}</div>
                                </div>
                            ))
                        ) : activeTab === 'cocktails' ? (
                            renderRecipeList(filteredCocktails)
                        ) : (
                            renderRecipeList(filteredPitchers)
                        )}
                    </div>
                </div>
            );
        };

        const Header = ({ 
            onNewPeriod, onClearAll, onDownload, onDownloadPDF, onShowCharts, 
            onBackup, onRestore, isCloud, onShopping, onShowPurchasesLog, 
            onShowSalesEntry, logoSrc, onLogoUpload, onShowCount, isSaving, 
            onToggleSearch, showSearch, 
            onFilterCategory, currentFilter, onStarClick,
            mobileSyncEnabled, onToggleMobileSync,
            onShowBottleSpecs 
        }) => {
            const [showMenu, setShowMenu] = useState(false);
            const dateStr = new Date().toLocaleDateString('en-US', { weekday: 'long', day: 'numeric', month: 'long' });
            
            return (
                <header className="bg-white/95 border-b border-slate-200 text-slate-800 p-4 shadow-sm backdrop-blur-sm sticky top-0 z-50">
                    <div className="max-w-7xl mx-auto flex flex-col lg:flex-row justify-between items-center gap-4">
                        <div className="flex items-center gap-4 w-full lg:w-auto">
                            <div className="bg-white rounded-full border border-slate-200 shadow-sm overflow-hidden h-21 w-21 flex-shrink-0 cursor-pointer hover:border-blue-500 transition-all relative group" onClick={() => document.getElementById('logo-upload').click()}>
                                <img src={logoSrc} alt="Logo" className="h-full w-full object-cover opacity-90 group-hover:opacity-100 transition-opacity" onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/100x100/4f46e5/ffffff?text=BAR"; }} />
                                <div className="absolute inset-0 bg-black/10 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-full"><Icons.Upload size={16} className="text-white" /></div>
                            </div>
                            <input type="file" id="logo-upload" accept="image/*" className="hidden" onChange={onLogoUpload} />
                            <div>
                                <h1 className="font-black text-2xl leading-tight text-slate-900 flex items-baseline gap-2 tracking-tight">MASTER BAR <span className="text-xs text-blue-600 font-mono tracking-widest border border-blue-200 px-1 rounded bg-blue-50">v{APP_VERSION}</span></h1>
                                <div className="flex items-center gap-3 text-xs mt-1 flex-wrap">
                                    <span className={`px-2 py-0.5 rounded-full border ${isCloud ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-slate-100 border-slate-200 text-slate-500'} flex items-center gap-1 font-bold uppercase tracking-wider`}>
                                        {isCloud ? <Icons.Cloud size={10} /> : <Icons.HardDrive size={10} />}
                                        {isCloud ? 'Cloud Online' : 'Local Mode'}
                                    </span>
                                    <span className="text-slate-400 font-bold uppercase tracking-[0.2em] text-[10px] border-l border-slate-200 pl-3 ml-1">{dateStr}</span>
                                    {isSaving && <span className="ml-2 flex items-center gap-2 px-3 py-0.5 rounded-full bg-emerald-50 border border-emerald-200 text-emerald-600 text-[10px] font-bold uppercase tracking-widest animate-in"><div className="w-1.5 h-1.5 rounded-full bg-emerald-500 saving-pulse"></div> Saving</span>}
                                </div>
                            </div>
                        </div>
                        <div className="flex flex-col lg:items-end gap-2 w-full lg:w-auto relative">
                            <div className="flex flex-wrap justify-center lg:justify-end gap-3 w-full lg:w-auto items-center">
                                
                                <button 
                                    onClick={onToggleMobileSync}
                                    className={`flex items-center gap-2 px-5 py-3 rounded-xl font-bold text-xs uppercase tracking-widest border transition-all active:scale-95 duration-500 ${
                                        mobileSyncEnabled 
                                        ? 'bg-emerald-600 text-white border-emerald-600 shadow-md animate-pulse' 
                                        : 'bg-white text-slate-400 border-slate-200 hover:bg-slate-50 hover:text-slate-600' 
                                    }`}
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round">
                                        <path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5" />
                                        <path d="M8.5 8.5a4 4 0 0 1 5.7 0" />
                                        <path d="M12 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" />
                                    </svg>
                                    <span>{mobileSyncEnabled ? "App Link: ACTIVE" : "App Link: OFF"}</span>
                                </button>

                                <button onClick={onToggleSearch} className={`flex items-center justify-center bg-white hover:bg-indigo-50 hover:text-indigo-600 text-slate-400 w-12 h-12 rounded-xl font-bold shadow-sm active:scale-95 border border-slate-200 transition-all ${showSearch ? 'ring-2 ring-indigo-500 text-indigo-600 bg-indigo-50' : ''}`}><Icons.Search size={20} /></button>
                                
                                <button onClick={onShowCount} className="flex items-center gap-2 bg-white hover:bg-emerald-600 hover:text-white text-emerald-600 px-6 py-3 rounded-xl font-bold shadow-sm hover:shadow-md active:scale-95 text-xs border border-emerald-200 hover:border-emerald-600 tracking-widest uppercase transition-all"><Icons.List size={18} /> COUNT</button>
                                
                                <button onClick={onStarClick} className="flex items-center justify-center w-12 h-12 rounded-xl font-bold shadow-sm active:scale-95 border border-amber-200 transition-all bg-white hover:bg-amber-50 text-amber-500"><Icons.Star size={20} fill="currentColor" /></button>

                                <button onClick={() => setShowMenu(!showMenu)} className={`flex items-center justify-center w-12 h-12 rounded-xl font-bold shadow-sm active:scale-95 border transition-all ${showMenu ? 'bg-slate-100 text-slate-800 border-slate-300' : 'bg-white hover:bg-slate-50 text-slate-400 hover:text-slate-600 border-slate-200'}`}><Icons.Settings size={20} /></button>
                            </div>
                            {showMenu && (<><div className="fixed inset-0 z-40" onClick={() => setShowMenu(false)}></div><div className="absolute top-full right-0 mt-4 w-72 bg-white border border-slate-200 rounded-2xl shadow-xl z-50 p-2 flex flex-col gap-1 animate-in origin-top-right"><div className="text-[9px] text-slate-400 uppercase font-black tracking-[0.3em] px-4 py-3 border-b border-slate-100 mb-1">System Controls</div>
                            
                            <div className="flex gap-2 p-1"><button onClick={() => { onBackup(); setShowMenu(false); }} className="flex-1 flex items-center justify-center gap-2 bg-slate-50 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 text-slate-600 p-3 rounded-xl text-xs font-bold border border-slate-200 transition-all"><Icons.Save size={14} /> Backup</button><button onClick={() => { onRestore(); setShowMenu(false); }} className="flex-1 flex items-center justify-center gap-2 bg-slate-50 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 text-slate-600 p-3 rounded-xl text-xs font-bold border border-slate-200 transition-all"><Icons.Upload size={14} /> Load</button></div>
                            
                            <button onClick={() => { onShowPurchasesLog(); setShowMenu(false); }} className="flex items-center gap-3 p-3 rounded-xl hover:bg-emerald-50 hover:text-emerald-600 text-slate-600 transition-all text-sm font-medium text-left"><Icons.Package size={18} /> Inbound Log</button>
                            <button onClick={() => { onShowSalesEntry(); setShowMenu(false); }} className="flex items-center gap-3 p-3 rounded-xl hover:bg-indigo-50 hover:text-indigo-600 text-slate-600 transition-all text-sm font-medium text-left"><Icons.DollarSign size={18} /> POS Manual Entry</button>
                            <button onClick={() => { onShopping(); setShowMenu(false); }} className="flex items-center gap-3 p-3 rounded-xl hover:bg-amber-50 hover:text-amber-600 text-slate-600 transition-all text-sm font-medium text-left"><Icons.ShoppingCart size={18} /> Procurement</button>
                            <button onClick={() => { onShowCharts(); setShowMenu(false); }} className="flex items-center gap-3 p-3 rounded-xl hover:bg-cyan-50 hover:text-cyan-600 text-slate-600 transition-all text-sm font-medium text-left"><Icons.BarChart size={18} /> Analytics</button>
                            
                            <button onClick={() => { onShowBottleSpecs(); setShowMenu(false); }} className="flex items-center gap-3 p-3 rounded-xl hover:bg-purple-50 hover:text-purple-600 text-slate-600 transition-all text-sm font-medium text-left">
                                <Icons.Settings size={18} className="text-purple-500" /> Bottle Specs (Weights)
                            </button>

                            <button onClick={() => { onDownloadPDF(); setShowMenu(false); }} className="flex items-center gap-3 p-3 rounded-xl hover:bg-pink-50 hover:text-pink-600 text-slate-600 transition-all text-sm font-medium text-left"><Icons.FileText size={18} /> Export PDF Report</button>
                            <button onClick={() => { onNewPeriod(); setShowMenu(false); }} className="flex items-center gap-3 p-3 rounded-xl hover:bg-emerald-50 hover:text-emerald-600 text-slate-600 transition-all text-sm font-medium text-left"><Icons.ArrowRight size={18} /> End Period / Start New</button>
                            <div className="h-px bg-slate-100 my-1 mx-2"></div>
                            <button onClick={() => { onClearAll(); setShowMenu(false); }} className="flex items-center gap-3 p-3 rounded-xl hover:bg-red-50 text-red-600 hover:text-red-700 transition-all text-sm font-bold text-left group uppercase tracking-wider"><Icons.Trash size={18} /> Factory Reset</button>
                            
                            </div></>)}
                        </div>
                    </div>
                </header>
            );
        };
        
        const createItem = (id, name) => ({ 
            id, 
            name, 
            weight_empty: "", 
            weight_full: "",
            bar1: "", bar2: "", bodega: "", barroluco: "", 
            start_bar1: "", start_bar2: "", start_bodega: "", start_barroluco: "", 
            purchases: "", sales: "", 
            sold_bottles: "", sold_shots: "", sold_comps: "", 
            barcode: "", barcode_case: "", 
            bar1_cooler: "", bar1_small_cooler_1: "", bar1_small_cooler_2: "", bar1_reaching: "", bar1_shelf_full: "", bar1_shelf_open: "", bar1_well_1: "", bar1_well_2: "", 
            bar2_cooler: "", bar2_small_cooler: "", 
            bodega_closet: "", bodega_shelves: "",
            sticker_ids: [] 
        });

        const INITIAL_DATA = [
            { category: "Premium Liquor (Tequila/Whisky)", items: [ createItem("liq-1", "Casamigos Blanco"), createItem("liq-2", "Casamigos Reposado"), createItem("liq-23", "Espolon Blanco"), createItem("liq-24", "Espolon Reposado"), createItem("liq-25", "Patron Cristalino"), createItem("liq-3", "Don Julio Blanco"), createItem("liq-4", "Don Julio Reposado"), createItem("liq-6", "Patron Silver"), createItem("liq-7", "Patron Reposado"), createItem("liq-8", "Clase Azul"), createItem("liq-9", "Grand Old Parr 12"), createItem("liq-11", "Crown Royal Regal"), createItem("liq-10", "Apple Crown Royal"), createItem("liq-26", "Hennessy VS"), createItem("liq-12", "Buchanans 12"), createItem("liq-13", "Johnnie Walker Black"), createItem("liq-14", "Capitan Morgan Spice"), createItem("liq-15", "Brugal Anejo"), createItem("liq-27", "Tito's Texas Vodka"), createItem("liq-16", "Grey Goose"), createItem("liq-17", "Jack Daniels Black"), createItem("liq-18", "WoodFord Reserve"), createItem("liq-19", "Fernet Branca"), createItem("liq-28", "Jagermeister"), createItem("liq-29", "Jameson"), createItem("liq-30", "Beefeater"), createItem("liq-32", "Wahaka Mezcal"), createItem("liq-31", "Malibu"), createItem("vin-4", "Moet Imperial Necta Rose"), createItem("liq-20", "Disaronno Amaretto"), createItem("vin-3", "Procecco Zonin"), createItem("liq-21", "Remy Martin"), createItem("liq-22", "Novo Fogo Silver Cachaca") ]},
            { category: "Wells (House Liquor)", items: [ createItem("wel-1", "Bacardi Light"), createItem("wel-2", "Bacardi Lime"), createItem("wel-13", "Bacardi Limon"), createItem("wel-3", "Pirassununga Cacha√ßa 51"), {...createItem("wel-4", "Barton Naturals Vodka"), barcode: "123456789012,210987654321"}, createItem("wel-15", "Barton Gin"), createItem("wel-5", "Peach Schnapps Boston"), createItem("wel-6", "Montezuma White"), createItem("wel-7", "Triple Sec Boston"), createItem("wel-8", "Long Island Tea Mix"), createItem("wel-9", "Curacao Blue"), createItem("wel-10", "Melon Boston"), createItem("wel-14", "Sour Apple"), createItem("wel-11", "Sour Apple HW"), createItem("wel-12", "Sour Cherry Boston") ]},
            { category: "Seltzer & Energy", items: [ createItem("sel-1", "Red Bull Sugar Free"), createItem("sel-2", "Red Bull Regular"), createItem("sel-3", "Red Bull Watermelon"), createItem("sel-4", "Red Bull Juneberry"), {...createItem("sel-5", "High Noon Variety Pack"), barcode: "987654321098,876543210987"} ]},
            { category: "Beers", items: [ createItem("cer-1", "Pacifico"), createItem("cer-2", "Michelob Ultra"), createItem("cer-3", "Modelo Especial"), createItem("cer-5", "Corona"), createItem("cer-4", "Heineken") ]},
            { category: "Wines", items: [ createItem("vin-1", "Sangria"), createItem("vin-2", "Chardonnay El Enemigo"), createItem("vin-5", "Cafayate Malbec") ]},
            { category: "Non Alcoholic", items: [ createItem("na-1", "Coca Cola"), createItem("na-2", "Diet Coke"), createItem("na-3", "Sprite"), createItem("na-4", "Ginger Ale"), createItem("na-5", "Water Bottle") ]}
        ];

        const PremiumControlModal = ({ isOpen, onClose, data, onUpdateStickers }) => {
            if (!isOpen) return null;
            const premiumCategory = data.find(cat => cat.category.includes("Premium"));
            const items = premiumCategory ? premiumCategory.items : [];
            const [searchTerm, setSearchTerm] = useState("");
            const [inputs, setInputs] = useState({});

            const handleInputChange = (itemId, val) => { setInputs(prev => ({ ...prev, [itemId]: val })); };

            const handleAddSticker = (item) => {
                const newSticker = inputs[item.id];
                if (!newSticker || !newSticker.trim()) return;
                const currentStickers = item.sticker_ids || [];
                if (currentStickers.includes(newSticker.trim())) { playSound('error'); return; }
                const newArray = [...currentStickers, newSticker.trim()];
                onUpdateStickers(item.id, newArray);
                setInputs(prev => ({ ...prev, [item.id]: "" }));
                playSound('add');
            };

            const handleRemoveSticker = (item, stickerToRemove) => {
                const currentStickers = item.sticker_ids || [];
                const newArray = currentStickers.filter(s => s !== stickerToRemove);
                onUpdateStickers(item.id, newArray);
                playSound('sub');
            };

            const filteredItems = items.filter(i => i.name.toLowerCase().includes(searchTerm.toLowerCase()));

            return (
                <div className="fixed inset-0 bg-white flex flex-col z-[90] animate-in overflow-hidden">
                    <div className="p-6 border-b border-slate-200 flex justify-between items-center bg-white">
                        <div><h2 className="text-2xl font-black text-slate-800 flex items-center gap-3"><Icons.Star className="text-amber-500" fill="currentColor" /> BOTTLE TRACKING</h2><p className="text-[10px] text-slate-400 uppercase tracking-widest mt-1">High Value Inventory Control</p></div>
                        <button onClick={onClose} className="px-6 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 font-bold text-xs uppercase tracking-widest border border-slate-200 transition-all">Exit</button>
                    </div>
                    <div className="p-4 bg-slate-50 border-b border-slate-200">
                        <div className="relative"><Icons.Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                        <input type="text" placeholder="SEARCH PREMIUM..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full bg-white border border-slate-200 rounded-xl pl-12 pr-4 py-4 text-slate-800 focus:outline-none focus:border-amber-500 transition-all font-bold tracking-wider text-sm" /></div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50">
                        {filteredItems.map(item => {
                            const stickers = item.sticker_ids || [];
                            return (
                                <div key={item.id} className="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm hover:border-amber-400 transition-all">
                                    <div className="flex justify-between items-start mb-4"><h3 className="font-bold text-slate-800 text-lg tracking-wide">{item.name}</h3><div className="bg-amber-50 text-amber-600 px-3 py-1 rounded-lg text-xs font-black border border-amber-200 uppercase tracking-widest">{stickers.length} UNITS</div></div>
                                    <div className="flex gap-3 mb-5"><input type="number" placeholder="Enter Tag #" className="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-800 font-mono focus:border-amber-500 outline-none transition-all" value={inputs[item.id] || ""} onChange={(e) => handleInputChange(item.id, e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleAddSticker(item)} /><button onClick={() => handleAddSticker(item)} className="bg-amber-500 hover:bg-amber-600 text-white px-6 py-3 rounded-xl font-black text-xs uppercase tracking-widest shadow-sm active:scale-95 transition-all">Add Tag</button></div>
                                    <div className="flex flex-wrap gap-2">{stickers.length === 0 && <span className="text-xs text-slate-300 italic tracking-wide">No tags active.</span>}{stickers.map((sticker, idx) => (<button key={idx} onClick={() => handleRemoveSticker(item, sticker)} className="group flex items-center gap-2 bg-slate-100 hover:bg-red-50 border border-slate-200 hover:border-red-200 px-3 py-1.5 rounded-lg transition-all animate-in" title="Remove (Sold)"><Icons.Barcode size={14} className="text-slate-400 group-hover:text-red-500" /><span className="font-mono font-bold text-slate-600 group-hover:text-red-600">{sticker}</span><span className="text-[10px] text-red-500 opacity-0 group-hover:opacity-100 font-bold ml-1">‚úï</span></button>))}</div>
                                </div>
                            );
                        })}
                        {filteredItems.length === 0 && <div className="text-center text-slate-300 mt-10 uppercase tracking-widest">No products found.</div>}
                    </div>
                </div>
            );
        };
        // ESTA ES LA PARTE 5 DE 5

        // --- MAIN APPLICATION LOGIC (LIGHT EDITION) ---
        function App() {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [data, setData] = useState(INITIAL_DATA);
            const [loading, setLoading] = useState(true);
            const [isCloud, setIsCloud] = useState(false);
            const [user, setUser] = useState(null);
            const [logo, setLogo] = useState(() => SafeStorage.getItem('BAR_LOGO') || "https://placehold.co/100x100/4f46e5/ffffff?text=BAR");
            
            const [mobileSyncEnabled, setMobileSyncEnabled] = useState(false);
            const mobileSyncRef = useRef(false);

            const fileInputRef = useRef(null);
            const LOCAL_STORAGE_KEY = 'bar-inventory-light-v9'; 

            const [showAddProduct, setShowAddProduct] = useState(false);
            const [showCountReview, setShowCountReview] = useState(false);
            const [showSearch, setShowSearch] = useState(false); 
            const [isSaving, setIsSaving] = useState(false);
            const isSavingRef = useRef(false); 

            const saveTimeoutRef = useRef(null);
            const [pendingImportData, setPendingImportData] = useState(null);
            const [showImportModal, setShowImportModal] = useState(false);
            const [notification, setNotification] = useState(null);
            const [modalConfig, setModalConfig] = useState(null);
            const [showCharts, setShowCharts] = useState(false);
            const [showShopping, setShowShopping] = useState(false);
            const [showPurchasesLog, setShowPurchasesLog] = useState(false);
            const [showSalesEntry, setShowSalesEntry] = useState(false);
            const [shoppingItems, setShoppingItems] = useState([]);
            const [pendingBarcode, setPendingBarcode] = useState(null);
            const [openCategories, setOpenCategories] = useState({});
            const [searchTerm, setSearchTerm] = useState("");
            const [categoryFilter, setCategoryFilter] = useState(null);

            const [showBottleSpecs, setShowBottleSpecs] = useState(false); 
            const [showPremiumModal, setShowPremiumModal] = useState(false);
            
            const [showResetSecurity, setShowResetSecurity] = useState(false);
            const [showSpecsSecurity, setShowSpecsSecurity] = useState(false); 
            const [securityCode, setSecurityCode] = useState("");

            const toggleMobileSync = async () => {
                const newValue = !mobileSyncEnabled;
                setMobileSyncEnabled(newValue);
                mobileSyncRef.current = newValue; 
                playSound(newValue ? 'success' : 'sub');
                if (isCloud && window.fb) {
                    try {
                        const db = window.fb.getFirestore();
                        const collectionPath = ENV_APP_ID !== 'default-app-id' ? `artifacts/${ENV_APP_ID}/public/data/inventory` : 'inventory';
                        await window.fb.setDoc(window.fb.doc(db, collectionPath, 'master'), { mobileAccess: newValue }, { merge: true });
                        showNotification(newValue ? "LINK ACTIVE: RECEIVING DATA" : "LINK OFFLINE: BLOCKED");
                    } catch(e) { console.error(e); }
                } else { showNotification("LOCAL MODE (OFFLINE)"); }
            };

            const updateItemStickers = (itemId, newStickersArray) => {
                const timestamp = Date.now();
                const newData = data.map(cat => ({ ...cat, items: cat.items.map(item => { if (item.id === itemId) return { ...item, sticker_ids: newStickersArray, lastUpdated: timestamp }; return item; }) }));
                saveData(newData);
            };

            useEffect(() => {
                const initApp = async () => {
                    const fb = window.fb;
                    const configToUse = ENV_FIREBASE_CONFIG || (FIREBASE_CONFIG.apiKey ? FIREBASE_CONFIG : null);
                    if (configToUse && fb) {
                        try {
                            const app = fb.initializeApp(configToUse);
                            const auth = fb.getAuth(app);
                            const db = fb.getFirestore(app);
                            if (ENV_AUTH_TOKEN) await fb.signInWithCustomToken(auth, ENV_AUTH_TOKEN); else await fb.signInAnonymously(auth);
                            fb.onAuthStateChanged(auth, (u) => {
                                setUser(u);
                                if (u) {
                                    setIsCloud(true);
                                    const collectionPath = ENV_APP_ID !== 'default-app-id' ? `artifacts/${ENV_APP_ID}/public/data/inventory` : 'inventory';
                                    const docRef = fb.doc(db, collectionPath, 'master');
                                    fb.onSnapshot(docRef, (docSnap) => {
                                        if (docSnap.exists()) { 
                                            const docData = docSnap.data();
                                            const isLocalChange = docSnap.metadata.hasPendingWrites; 
                                            if (!mobileSyncRef.current && docData.mobileAccess === true && loading) { setMobileSyncEnabled(true); mobileSyncRef.current = true; }
                                            if (docData.items) { if (isLocalChange) { setData(docData.items); } else { if (mobileSyncRef.current === true) { setData(docData.items); } } }
                                        } else { fb.setDoc(docRef, { items: INITIAL_DATA, mobileAccess: false }); setData(INITIAL_DATA); }
                                        setLoading(false);
                                    }, (err) => { console.warn(err); setIsCloud(false); loadLocal(); });
                                } else { loadLocal(); }
                            });
                        } catch (e) { console.warn(e); setIsCloud(false); loadLocal(); }
                    } else { setIsCloud(false); loadLocal(); }
                };
                const loadLocal = () => { const saved = SafeStorage.getItem(LOCAL_STORAGE_KEY); if (saved) setData(JSON.parse(saved)); else setData(INITIAL_DATA); setLoading(false); };
                initApp();
            }, []);

            const generatePDF = async () => {
                showNotification("GENERATING REPORT...");
                let items = []; let totalConsumed = 0; let totalSold = 0; let totalDiff = 0; let catMap = {}; 
                const categorySummary = {}; 
                
                // 1. Process Data
                data.forEach(cat => { 
                    let cSales = 0; 
                    if (!categorySummary[cat.category]) categorySummary[cat.category] = { used: 0, sold: 0, variance: 0 };
                    cat.items.forEach(item => {
                        const totalPhys = (parseFloat(item.bar1)||0) + (parseFloat(item.bar2)||0) + (parseFloat(item.bodega)||0) + (parseFloat(item.barroluco)||0);
                        const totalStart = (parseFloat(item.start_bar1)||0) + (parseFloat(item.start_bar2)||0) + (parseFloat(item.start_bodega)||0) + (parseFloat(item.start_barroluco)||0);
                        const purchases = parseFloat(item.purchases)||0; const sales = parseFloat(item.sales)||0;
                        const systemConsumption = totalStart + purchases - totalPhys;
                        const diff = sales - systemConsumption;
                        if (systemConsumption > 0 || sales > 0) { 
                            items.push({ ...item, category: cat.category, totalStart, totalPhys, purchases, systemConsumption, sales, diff }); 
                            totalConsumed += systemConsumption; totalSold += sales; totalDiff += diff; cSales += sales; 
                            categorySummary[cat.category].used += systemConsumption; categorySummary[cat.category].sold += sales; categorySummary[cat.category].variance += diff;
                        }
                    }); 
                    if (cSales > 0) catMap[cat.category] = cSales; 
                });

                // 2. Weighted Rating Calculation
                let weightedScore = 0;
                
                const getWeight = (cat) => {
                    if (cat.includes("Premium")) return 0.40; // 40%
                    if (cat.includes("Beers")) return 0.30;   // 30%
                    if (cat.includes("Seltzer")) return 0.15; // 15%
                    if (cat.includes("Wines")) return 0.10;   // 10%
                    if (cat.includes("Wells")) return 0.05;   // 5%
                    return 0;
                };

                Object.entries(categorySummary).forEach(([cat, stats]) => {
                    const weight = getWeight(cat);
                    let catScore = 100;
                    if (stats.used > 0) {
                        // Score formula: 100 - (% Error)
                        const errorPct = (Math.abs(stats.variance) / stats.used) * 100;
                        catScore = Math.max(0, 100 - errorPct);
                    }
                    weightedScore += (catScore * weight);
                });

                const score = weightedScore; // Final weighted score
                const grade = score >= 95 ? "A" : score >= 85 ? "B" : "C"; 
                const scoreColor = score >= 95 ? [34, 197, 94] : score >= 85 ? [234, 179, 8] : [239, 68, 68];

                items.sort((a, b) => a.diff - b.diff); 
                const topLosses = items.filter(i => i.diff < 0).slice(0, 5);
                
                const createChartImage = (config) => { return new Promise((resolve) => { const canvas = document.getElementById('pdf-chart-canvas'); const ctx = canvas.getContext('2d'); ctx.save(); ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.restore(); const pdfConfig = { ...config, options: { ...config.options, animation: false, responsive: false, devicePixelRatio: 2, color: '#000000', plugins: { ...config.options?.plugins, legend: { ...config.options?.plugins?.legend, labels: { color: '#000000', font: { size: 14 } } }, title: { ...config.options?.plugins?.title, color: '#000000', font: { size: 18, weight: 'bold' } }, datalabels: { color: '#000000' } }, scales: config.type !== 'pie' ? { x: { ticks: { color: '#000000' }, grid: { color: '#cccccc' } }, y: { ticks: { color: '#000000' }, grid: { color: '#cccccc' } } } : {} } }; if (window.pdfChart) window.pdfChart.destroy(); window.pdfChart = new Chart(ctx, pdfConfig); setTimeout(() => { try { ctx.globalCompositeOperation = 'destination-over'; ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, canvas.width, canvas.height); const img = canvas.toDataURL('image/jpeg', 1.0); resolve(img); } catch (e) { resolve(null); } }, 500); }); };
                const chartImg1 = await createChartImage({ type: 'pie', data: { labels: Object.keys(catMap).map(k => k.split(' ')[0]), datasets: [{ data: Object.values(catMap), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6', '#6366f1', '#ef4444'] }] }, options: { plugins: { title: { display: true, text: 'Sales Share' }, legend: { position: 'bottom' } } } });
                const chartImg2 = await createChartImage({ type: 'bar', data: { labels: topLosses.map(i => i.name), datasets: [{ label: 'Loss (Units)', data: topLosses.map(i => i.diff), backgroundColor: '#ef4444' }] }, options: { indexAxis: 'y', plugins: { title: { display: true, text: 'Top 5 Product Losses' }, legend: { display: false } } } });
                const { jsPDF } = window.jspdf; const doc = new jsPDF(); const dateText = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                if (logo && logo.startsWith("data:image")) { try { doc.addImage(logo, "JPEG", 15, 10, 15, 15); } catch (err) { } }
                doc.setFontSize(22); doc.setTextColor(40); doc.setFont("helvetica", "bold"); doc.text("PALMAS TROPICAL ESCAPE", 35, 20); doc.setFontSize(10); doc.setTextColor(100); doc.setFont("helvetica", "normal"); doc.text(`Report Date: ${dateText}`, 35, 26); doc.line(15, 30, 195, 30); 
                
                // RATING SECTION (UPDATED)
                doc.setFillColor(245, 247, 250); doc.roundedRect(15, 35, 40, 30, 2, 2, 'F'); doc.setFontSize(9); doc.setTextColor(100); doc.text("WEIGHTED RATING", 35, 42, { align: 'center' }); doc.setFontSize(24); doc.setTextColor(...scoreColor); doc.setFont("helvetica", "bold"); doc.text(grade, 35, 53, { align: 'center' }); doc.setFontSize(10); doc.text(`${score.toFixed(1)}%`, 35, 60, { align: 'center' });
                
                doc.setFillColor(245, 247, 250); doc.roundedRect(60, 35, 40, 30, 2, 2, 'F'); doc.setFontSize(9); doc.setTextColor(100); doc.setFont("helvetica", "normal"); doc.text("TOTAL CONSUMED", 80, 42, { align: 'center' }); doc.setFontSize(16); doc.setTextColor(40); doc.setFont("helvetica", "bold"); doc.text(totalConsumed.toFixed(1), 80, 52, { align: 'center' }); doc.setFontSize(8); doc.text("Units Used", 80, 58, { align: 'center' });
                doc.setFillColor(245, 247, 250); doc.roundedRect(105, 35, 40, 30, 2, 2, 'F'); doc.setFontSize(9); doc.setTextColor(100); doc.setFont("helvetica", "normal"); doc.text("TOTAL SOLD", 125, 42, { align: 'center' }); doc.setFontSize(16); doc.setTextColor(79, 70, 229); doc.setFont("helvetica", "bold"); doc.text(totalSold.toFixed(1), 125, 52, { align: 'center' }); doc.setFontSize(8); doc.setTextColor(40); doc.text("Units Sold (POS)", 125, 58, { align: 'center' });
                doc.setFillColor(totalDiff < 0 ? 254 : 240, totalDiff < 0 ? 242 : 253, totalDiff < 0 ? 242 : 244); doc.roundedRect(150, 35, 45, 30, 2, 2, 'F'); doc.setFontSize(9); doc.setTextColor(100); doc.setFont("helvetica", "normal"); doc.text("VARIANCE", 172.5, 42, { align: 'center' }); doc.setFontSize(16); doc.setTextColor(totalDiff < 0 ? 220 : 34, totalDiff < 0 ? 38 : 139, 38); doc.setFont("helvetica", "bold"); doc.text(`${totalDiff > 0 ? '+' : ''}${totalDiff.toFixed(1)}`, 172.5, 52, { align: 'center' }); doc.setFontSize(8); doc.text(totalDiff < 0 ? "Loss" : "Gain", 172.5, 58, { align: 'center' });
                
                const catSummaryData = Object.entries(categorySummary).map(([cat, vals]) => [ cat, vals.used.toFixed(1), vals.sold.toFixed(1), vals.variance.toFixed(1), `${vals.used > 0 ? ((vals.variance / vals.used) * 100).toFixed(1) : '0.0'}%` ]); doc.autoTable({ startY: 75, head: [['Category', 'Used', 'Sold', 'Variance', '% Var']], body: catSummaryData, theme: 'grid', headStyles: { fillColor: [55, 65, 81], textColor: 255, fontStyle: 'bold' }, styles: { fontSize: 9, cellPadding: 3 }, columnStyles: { 3: { fontStyle: 'bold' }, 4: { halign: 'right' } }, didParseCell: function(data) { if (data.column.index === 3) { const val = parseFloat(data.cell.raw); data.cell.styles.textColor = val < 0 ? [220, 38, 38] : [22, 163, 74]; } } }); let yPos = doc.lastAutoTable.finalY + 10; if (chartImg1) { doc.addImage(chartImg1, 'JPEG', 15, yPos, 80, 60); } if (chartImg2) { doc.addImage(chartImg2, 'JPEG', 105, yPos, 90, 60); } doc.addPage(); doc.setFontSize(16); doc.setTextColor(40); doc.text("Top Loss Leaders", 15, 20); doc.autoTable({ startY: 30, head: [['Item Name', 'Category', 'Missing Units']], body: topLosses.map(i => [i.name, i.category, i.diff.toFixed(2)]), theme: 'striped', headStyles: { fillColor: [220, 38, 38] }, styles: { fontSize: 10 } }); doc.addPage(); doc.setFontSize(16); doc.setTextColor(40); doc.text("Detailed Inventory Report", 15, 20); doc.autoTable({ startY: 30, head: [['Product', 'Cat', 'Start', 'Buy', 'End', 'Used', 'Sold', 'Diff']], body: items.map(i => [ i.name, i.category.split(' ')[0], i.totalStart, i.purchases || 0, i.totalPhys, i.systemConsumption.toFixed(2), i.sales.toFixed(2), i.diff.toFixed(2) ]), styles: { fontSize: 8, cellPadding: 2, textColor: [0,0,0] }, headStyles: { fillColor: [30, 30, 30], textColor: 255 }, didParseCell: function(data) { if (data.section === 'body' && data.column.index === 7) { const val = parseFloat(data.cell.raw); if (val < -0.1) { data.cell.styles.fillColor = [255, 230, 230]; data.cell.styles.textColor = [180, 0, 0]; data.cell.styles.fontStyle = 'bold'; } else if (val > 0.1) { data.cell.styles.fillColor = [230, 255, 230]; data.cell.styles.textColor = [0, 100, 0]; data.cell.styles.fontStyle = 'bold'; } } } }); doc.save(`Executive_Report_${dateText.replace(/ /g, '_')}.pdf`); showNotification("REPORT EXPORTED");
            };

            const downloadReport = () => { const dateObj = new Date(); const safeDate = dateObj.toISOString().split('T')[0]; let items = []; let totalConsumed = 0; let totalSold = 0; let totalDiff = 0; data.forEach(cat => { cat.items.forEach(item => { const totalPhys = (parseFloat(item.bar1)||0) + (parseFloat(item.bar2)||0) + (parseFloat(item.bodega)||0) + (parseFloat(item.barroluco)||0); const totalStart = (parseFloat(item.start_bar1)||0) + (parseFloat(item.start_bar2)||0) + (parseFloat(item.start_bodega)||0) + (parseFloat(item.start_barroluco)||0); const purchases = parseFloat(item.purchases)||0; const sales = parseFloat(item.sales)||0; const systemConsumption = totalStart + purchases - totalPhys; const diff = sales - systemConsumption; if (systemConsumption > 0 || sales > 0) { items.push({ ...item, category: cat.category, totalStart, totalPhys, purchases, systemConsumption, sales, diff }); totalConsumed += systemConsumption; totalSold += sales; totalDiff += diff; } })}); let csv = `EXECUTIVE REPORT\nDate: ${safeDate}\n\nSUMMARY\nTotal Consumed,${totalConsumed.toFixed(2)}\nTotal Sold,${totalSold.toFixed(2)}\nNet Diff,${totalDiff.toFixed(2)}\n\nDETAILS\nPRODUCT,CAT,START,BUY,END,USED,SOLD,DIFF\n`; items.forEach(i => { csv += `"${i.name}","${i.category}",${i.totalStart},${i.purchases},${i.totalPhys},${i.systemConsumption},${i.sales},${i.diff}\n` }); const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = `Report_${safeDate}.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const updateItem = (itemId, fieldOrObj, value) => { const timestamp = Date.now(); const newData = data.map(cat => ({ ...cat, items: cat.items.map(item => { if (item.id === itemId) { if (typeof fieldOrObj === 'object' && fieldOrObj !== null) return { ...item, ...fieldOrObj, lastUpdated: timestamp }; return { ...item, [fieldOrObj]: value, lastUpdated: timestamp }; } return item; }) })); saveData(newData); };
            const batchUpdateItems = (updates) => { const timestamp = Date.now(); const newData = data.map(cat => ({ ...cat, items: cat.items.map(item => { const update = updates.find(u => u.id === item.id); if (update) return { ...item, ...update.changes, lastUpdated: timestamp }; return item; }) })); saveData(newData); };
            const saveData = (newData) => { setData(newData); const fb = window.fb; if (isCloud && user && fb) { setIsSaving(true); isSavingRef.current = true; if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current); saveTimeoutRef.current = setTimeout(() => { try { const db = fb.getFirestore(); const collectionPath = ENV_APP_ID !== 'default-app-id' ? `artifacts/${ENV_APP_ID}/public/data/inventory` : 'inventory'; fb.setDoc(fb.doc(db, collectionPath, 'master'), { items: newData, mobileAccess: mobileSyncRef.current }, { merge: true }).then(() => { setIsSaving(false); isSavingRef.current = false; }).catch(() => { setIsSaving(false); isSavingRef.current = false; }); } catch(e) { console.error(e); setIsSaving(false); isSavingRef.current = false; } }, 2000); } else { SafeStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(newData)); } };
            const showNotification = (msg) => { setNotification(msg); setTimeout(() => setNotification(null), 3000); };
            const handleAddNewProduct = (name, category) => { const newId = `custom-${Date.now()}`; const newItem = createItem(newId, name); const newData = data.map(cat => { if (cat.category === category) return { ...cat, items: [...cat.items, newItem] }; return cat; }); saveData(newData); showNotification(`ADDED: ${name}`); };
            const handleLogoChange = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (ev) => { const base64 = ev.target.result; setLogo(base64); SafeStorage.setItem('BAR_LOGO', base64); showNotification("LOGO UPDATED"); }; reader.readAsDataURL(file); };
            const handleRestoreFile = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (ev) => { try { const d = JSON.parse(ev.target.result); if (Array.isArray(d) && d[0].category) { setPendingImportData(d); setShowImportModal(true); } else { showNotification("INVALID FILE FORMAT"); } } catch(err) { showNotification("READ ERROR"); } }; reader.readAsText(file); e.target.value = null; };
            const handleReplaceData = () => { if (pendingImportData) { saveData(pendingImportData); showNotification("DATA REPLACED"); setShowImportModal(false); setPendingImportData(null); } };
            const handleMergeData = () => { if (!pendingImportData) return; const newData = JSON.parse(JSON.stringify(data)); pendingImportData.forEach(incomingCat => { let targetCat = newData.find(c => c.category === incomingCat.category); if (!targetCat) { newData.push(incomingCat); return; } incomingCat.items.forEach(incomingItem => { let targetItem = targetCat.items.find(i => i.id === incomingItem.id); if (!targetItem) { targetCat.items.push(incomingItem); } else { const numericFields = ['bar1', 'bar2', 'bodega', 'barroluco', 'start_bar1', 'start_bar2', 'start_bodega', 'start_barroluco', 'purchases', 'sales', 'sold_bottles', 'sold_shots', 'sold_comps', 'bar1_cooler', 'bar1_small_cooler_1', 'bar1_small_cooler_2', 'bar1_reaching', 'bar1_shelf_full', 'bar1_shelf_open', 'bar1_well_1', 'bar1_well_2', 'bar2_cooler', 'bar2_small_cooler', 'bodega_closet', 'bodega_shelves']; numericFields.forEach(field => { const currentVal = parseFloat(targetItem[field]) || 0; const incomingVal = parseFloat(incomingItem[field]) || 0; if (incomingVal !== 0) { const sum = currentVal + incomingVal; targetItem[field] = sum !== 0 ? sum.toString() : ""; } }); if (!targetItem.barcode && incomingItem.barcode) targetItem.barcode = incomingItem.barcode; if (!targetItem.barcode_case && incomingItem.barcode_case) targetItem.barcode_case = incomingItem.barcode_case; } }); }); saveData(newData); showNotification("DATA MERGED"); setShowImportModal(false); setPendingImportData(null); };
            const handleBackup = () => { const blob = new Blob([JSON.stringify(data)], { type: "application/json" }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = `Bar_Backup_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const requestItemScan = (itemId, type = 'unit') => { showNotification("Feature not available in PC Version"); };
            const handleDeleteProduct = (item) => { setModalConfig({ title: "Delete Item?", message: `Permanently remove "${item.name}"?`, isDestructive: true, onConfirm: () => { const newData = data.map(cat => ({ ...cat, items: cat.items.filter(i => i.id !== item.id) })); saveData(newData); setModalConfig(null); showNotification(`DELETED: ${item.name}`); } }); };
            // --- PEGAR ESTO EN MASTER CONTROL (Reemplazar la funci√≥n confirmNewPeriod existente) ---
            const confirmNewPeriod = () => { 
                setModalConfig({ 
                    title: "Start Next Period?", 
                    message: "Generates 'Last Count' snapshot for Quick Mode.\nClears current counts & SLOTS.", 
                    isDestructive: false, 
                    onConfirm: () => { 
                        const newData = data.map(cat => ({ 
                            ...cat, 
                            items: cat.items.map(item => { 
                                // 1. SNAPSHOT: Guardar historial exacto por cada zona peque√±a
                                const zoneHistory = {};
                                
                                // Recorremos tu configuraci√≥n de zonas para guardar lo que hay en cada rinc√≥n
                                Object.values(ZONES_CONFIG).forEach(zoneList => {
                                    zoneList.forEach(z => {
                                        // AQUI EST√Å LA CLAVE: Guardamos "last_bar1_shelf_open" = 0.34
                                        zoneHistory[`last_${z.id}`] = parseFloat(item[z.id]) || 0;
                                    });
                                });

                                // Tambi√©n guardamos zonas principales por si acaso
                                ['bar1', 'bar2', 'bodega', 'barroluco'].forEach(mainZone => {
                                    zoneHistory[`last_${mainZone}`] = parseFloat(item[mainZone]) || 0;
                                });

                                // 2. Calcular On Hand Global (Total General)
                                const valBar1 = parseFloat(item.bar1) || 0;
                                const valBar2 = parseFloat(item.bar2) || 0;
                                const valBodega = parseFloat(item.bodega) || 0;
                                const valBarroluco = parseFloat(item.barroluco) || 0;
                                const totalEndingCount = valBar1 + valBar2 + valBodega + valBarroluco;

                                return { 
                                    ...item, 
                                    ...zoneHistory, // Inyectamos el historial detallado
                                    on_hand: totalEndingCount, // Inyectamos el total global

                                    // L√≥gica normal de mover a Start
                                    start_bar1: valBar1, 
                                    start_bar2: valBar2, 
                                    start_bodega: valBodega, 
                                    start_barroluco: valBarroluco, 
                                    
                                    // RESETEAR TODO A 0
                                    bar1: "", bar2: "", bodega: "", barroluco: "", 
                                    purchases: "", sales: "", 
                                    sold_bottles: "", sold_shots: "", sold_comps: "", 
                                    
                                    // RESETEAR ZONAS ESPEC√çFICAS
                                    bar1_cooler: "", 
                                    breakdown_bar1_cooler: [0, 0, 0, 0], // Limpiar slots
                                    
                                    bar1_small_cooler_1: "", bar1_small_cooler_2: "", 
                                    bar1_reaching: "", bar1_shelf_full: "", bar1_shelf_open: "", 
                                    bar1_well_1: "", bar1_well_2: "", 
                                    bar2_cooler: "", bar2_small_cooler: "", 
                                    bodega_closet: "", bodega_shelves: "" 
                                }; 
                            }) 
                        })); 
                        saveData(newData); 
                        setModalConfig(null); 
                        showNotification("PERIOD RESET & HISTORY SAVED"); 
                    } 
                }); 
            };
            
            const performFactoryReset = () => {
                if (securityCode === "Enzo2022") { saveData(INITIAL_DATA); setShowResetSecurity(false); setSecurityCode(""); playSound('success'); showNotification("FACTORY RESET COMPLETE"); } 
                else { playSound('error'); showNotification("ACCESS DENIED: WRONG CODE"); }
            };

            const verifySpecsAccess = () => {
                if (securityCode === "Enzo2022") { playSound('success'); setShowSpecsSecurity(false); setSecurityCode(""); setShowBottleSpecs(true); } 
                else { playSound('error'); showNotification("ACCESS DENIED: WRONG CODE"); }
            };

            const confirmClearAll = () => {
                setModalConfig({
                    title: "Reset Inventory Options",
                    message: "What type of reset?",
                    isDestructive: true,
                    customActions: [
                        { label: "Counts Only", class: "bg-blue-50 hover:bg-blue-100 text-blue-600 border border-blue-200", onClick: () => { const newData = data.map(cat => ({ ...cat, items: cat.items.map(item => ({ ...item, bar1: "", bar2: "", bodega: "", barroluco: "", start_bar1: "", start_bar2: "", start_bodega: "", start_barroluco: "", purchases: "", sales: "", sold_bottles: "", sold_shots: "", sold_comps: "", bar1_cooler: "", bar1_small_cooler_1: "", bar1_small_cooler_2: "", bar1_reaching: "", bar1_shelf_full: "", bar1_shelf_open: "", bar1_well_1: "", bar1_well_2: "", bar2_cooler: "", bar2_small_cooler: "", bodega_closet: "", bodega_shelves: "" })) })); saveData(newData); setModalConfig(null); showNotification("COUNTS RESET"); } },
                        { label: "Factory Reset", class: "bg-red-50 hover:bg-red-100 text-red-600 border border-red-200", onClick: () => { setModalConfig(null); setSecurityCode(""); setShowResetSecurity(true); } }
                    ]
                });
            };

            const generateShoppingList = () => { const toBuy = []; data.forEach(cat => { cat.items.forEach(item => { const target = PAR_LEVELS[item.name]; if (target !== undefined) { const current = (parseFloat(item.bar1)||0) + (parseFloat(item.bar2)||0) + (parseFloat(item.bodega)||0) + (parseFloat(item.barroluco)||0); const needed = target - current; if (needed > 0) { let displayQuantity = needed; let details = null; const customRound = (val) => { const decimal = val - Math.floor(val); return decimal > 0.5 ? Math.ceil(val) : Math.floor(val); }; if (cat.category.includes("Beers") || item.name.includes("Red Bull")) { const cases = customRound(needed / 24); displayQuantity = `${cases} Cases`; details = `(${needed} units needed)`; } else { displayQuantity = customRound(needed); } toBuy.push({ name: item.name, current, target, needed: displayQuantity, details }); } } }); }); setShoppingItems(toBuy); setShowShopping(true); };
            const getIcon = (n) => { if (n.includes("Premium")) return Icons.GlassWater; if (n.includes("Wells")) return Icons.Package; if (n.includes("Beers")) return Icons.Beer; if (n.includes("Wines")) return Icons.Wine; if (n.includes("Non Alcoholic")) return Icons.Leaf; return Icons.RefreshCw; };
            const filteredData = useMemo(() => { let filtered = data; if (categoryFilter) { filtered = data.filter(cat => cat.category === categoryFilter); } if (!searchTerm) return filtered; const normalize = (str) => str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); const term = normalize(searchTerm); const tightTerm = term.replace(/\s+/g, ''); return filtered.map(cat => ({ ...cat, items: cat.items.filter(item => { const nameMatch = normalize(item.name).includes(term); const catMatch = normalize(cat.category).includes(term); const tightMatch = normalize(item.name).replace(/\s+/g, '').includes(tightTerm); return nameMatch || catMatch || tightMatch; }) })).filter(cat => cat.items.length > 0); }, [data, searchTerm, categoryFilter]);

            if (loading) return <div className="flex items-center justify-center min-h-screen text-blue-500 font-mono tracking-widest animate-pulse">ESTABLISHING UPLINK...</div>;
            if (!isAuthenticated) return <ErrorBoundary><LoginScreen onLogin={() => { setIsAuthenticated(true); playSound('success'); }} logoSrc={logo} onLogoUpload={handleLogoChange}/></ErrorBoundary>;

            return (
                <div className="min-h-screen bg-slate-50 font-sans pb-20">
                    <div className="sticky top-0 left-0 right-0 z-50 shadow-sm bg-white/95 backdrop-blur-sm">
                        <Header 
                            onNewPeriod={confirmNewPeriod} onClearAll={confirmClearAll} onDownload={downloadReport} onDownloadPDF={generatePDF} 
                            onShowCharts={() => setShowCharts(true)} onBackup={handleBackup} onRestore={() => fileInputRef.current.click()} 
                            isCloud={isCloud} onShopping={generateShoppingList} onShowPurchasesLog={() => setShowPurchasesLog(true)} 
                            onShowSalesEntry={() => setShowSalesEntry(true)} logoSrc={logo} onLogoUpload={handleLogoChange} 
                            onAddProduct={() => setShowAddProduct(true)} onShowCount={() => setShowCountReview(true)} isSaving={isSaving} 
                            onToggleSearch={() => setShowSearch(!showSearch)} showSearch={showSearch} onFilterCategory={setCategoryFilter} 
                            currentFilter={categoryFilter} onStarClick={() => setShowPremiumModal(true)} mobileSyncEnabled={mobileSyncEnabled} 
                            onToggleMobileSync={toggleMobileSync} onShowBottleSpecs={() => { setSecurityCode(""); setShowSpecsSecurity(true); }}
                        />
                        {showSearch && (
                            <div className="bg-white p-4 border-b border-slate-200 animate-in"><div className="max-w-6xl mx-auto relative flex gap-3"><div className="relative flex-1"><Icons.Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={20} /><input type="text" placeholder="QUERY DATABASE..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full bg-slate-50 rounded-xl pl-12 pr-4 py-4 text-slate-800 border border-slate-200 focus:outline-none focus:border-blue-500 transition-all text-sm" autoFocus/></div><button onClick={() => { setShowSearch(false); setSearchTerm(""); }} className="bg-slate-100 hover:bg-slate-200 text-slate-600 px-6 rounded-xl font-bold border border-slate-200 text-xs">Close</button></div></div>
                        )}
                    </div>
                    <input type="file" ref={fileInputRef} style={{display:'none'}} accept=".json" onChange={handleRestoreFile} />
                    <main className="max-w-7xl mx-auto p-6 space-y-6 pt-8">
                        {categoryFilter && (
                            <div className="flex items-center justify-between bg-amber-50 border border-amber-200 p-4 rounded-xl mb-6 shadow-sm">
                                <span className="text-amber-700 font-bold text-sm uppercase tracking-wider flex items-center gap-2"><div className="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></div> FILTER ACTIVE: {categoryFilter}</span>
                                <button onClick={() => setCategoryFilter(null)} className="text-slate-500 hover:text-slate-800 text-xs font-bold uppercase tracking-widest hover:underline transition-all">Clear Filter</button>
                            </div>
                        )}
                        {filteredData.length === 0 && <div className="text-center py-32 text-slate-400 uppercase tracking-widest font-medium"><p>No entries found in database.</p></div>}
                        {filteredData.map((cat) => (<div key={cat.category} className="mb-8">{!searchTerm && <CategoryHeader title={cat.category} icon={getIcon(cat.category)} isOpen={openCategories[cat.category]} toggle={() => setOpenCategories(prev => ({...prev, [cat.category]: !prev[cat.category]}))} />}{(openCategories[cat.category] || searchTerm || categoryFilter) && (<div className="grid gap-3 sm:grid-cols-1 lg:grid-cols-2">{cat.items.map(item => (<InventoryRow key={item.id} item={item} onUpdate={updateItem} pendingBarcode={pendingBarcode} isWells={cat.category.includes("Wells")} categoryName={cat.category} onScanRequest={requestItemScan} onDelete={handleDeleteProduct} />))}</div>)}</div>))}
                    </main>
                    <button onClick={() => setShowAddProduct(true)} className="fixed bottom-8 right-8 z-40 bg-blue-600 text-white p-5 rounded-full shadow-lg hover:bg-blue-700 hover:shadow-xl transition-all active:scale-95 group" title="New Entry"><Icons.Plus size={32} className="group-hover:rotate-90 transition-transform duration-300" /></button>
                    
                    <ConfirmationModal isOpen={!!modalConfig} onClose={() => setModalConfig(null)} onConfirm={modalConfig?.onConfirm} title={modalConfig?.title} message={modalConfig?.message} isDestructive={modalConfig?.isDestructive} customActions={modalConfig?.customActions}/>
                    <ImportModal isOpen={showImportModal} onClose={() => { setShowImportModal(false); setPendingImportData(null); }} onReplace={handleReplaceData} onMerge={handleMergeData} />
                    <AddProductModal isOpen={showAddProduct} onClose={() => setShowAddProduct(false)} onAdd={handleAddNewProduct} categories={data.map(c => c.category)} />
                    {showCharts && <ChartsView data={data} onClose={() => setShowCharts(false)} />}
                    {showShopping && <ShoppingListModal isOpen={showShopping} onClose={() => setShowShopping(false)} items={shoppingItems} />}
                    {showPurchasesLog && <PurchasesLogModal isOpen={showPurchasesLog} onClose={() => setShowPurchasesLog(false)} data={data} />}
                    {showSalesEntry && <SalesEntryModal isOpen={showSalesEntry} onClose={() => setShowSalesEntry(false)} data={data} onUpdate={updateItem} onBatchUpdate={batchUpdateItems} />}
                    {showCountReview && <CountReviewModal isOpen={showCountReview} onClose={() => setShowCountReview(false)} data={data} onUpdate={updateItem} />}
                    <PremiumControlModal isOpen={showPremiumModal} onClose={() => setShowPremiumModal(false)} data={data} onUpdateStickers={updateItemStickers} />
                    <BottleSpecsModal isOpen={showBottleSpecs} onClose={() => setShowBottleSpecs(false)} data={data} onUpdate={updateItem} />

                    {showResetSecurity && (
                        <div className="fixed inset-0 bg-slate-900/50 flex flex-col items-center justify-center z-[110] backdrop-blur-sm animate-in p-4">
                            <div className="bg-white border border-red-200 w-full max-w-sm rounded-2xl p-8 shadow-2xl text-center relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-1 bg-red-500"></div>
                                <Icons.AlertTriangle size={48} className="text-red-500 mx-auto mb-4" />
                                <h2 className="text-2xl font-black text-slate-800 mb-2 uppercase">Security Check</h2>
                                <p className="text-slate-500 text-xs mb-6 font-mono">AUTHORIZED PERSONNEL ONLY</p>
                                <input type="password" value={securityCode} onChange={(e) => setSecurityCode(e.target.value)} className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-4 text-center text-slate-800 font-mono text-lg focus:border-red-500 outline-none mb-6 tracking-widest" placeholder="ENTER PASSCODE" autoFocus />
                                <div className="flex gap-3"><button onClick={() => setShowResetSecurity(false)} className="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 hover:text-slate-800 font-bold text-xs uppercase tracking-wider">Cancel</button><button onClick={performFactoryReset} className="flex-1 py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-bold text-xs uppercase tracking-wider shadow-lg">Confirm</button></div>
                            </div>
                        </div>
                    )}

                    {showSpecsSecurity && (
                        <div className="fixed inset-0 bg-slate-900/50 flex flex-col items-center justify-center z-[110] backdrop-blur-sm animate-in p-4">
                            <div className="bg-white border border-indigo-200 w-full max-w-sm rounded-2xl p-8 shadow-2xl text-center relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-1 bg-indigo-500"></div>
                                <Icons.Settings size={48} className="text-indigo-500 mx-auto mb-4" />
                                <h2 className="text-2xl font-black text-slate-800 mb-2 uppercase">Configuration Access</h2>
                                <p className="text-slate-500 text-xs mb-6 font-mono">MANAGEMENT AUTHORIZATION REQUIRED</p>
                                <input type="password" value={securityCode} onChange={(e) => setSecurityCode(e.target.value)} className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-4 text-center text-slate-800 font-mono text-lg focus:border-indigo-500 outline-none mb-6 tracking-widest" placeholder="ENTER PASSCODE" autoFocus />
                                <div className="flex gap-3"><button onClick={() => setShowSpecsSecurity(false)} className="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 hover:text-slate-800 font-bold text-xs uppercase tracking-wider">Cancel</button><button onClick={verifySpecsAccess} className="flex-1 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-xs uppercase tracking-wider shadow-lg">Access</button></div>
                            </div>
                        </div>
                    )}

                    {notification && (<div className="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-8 py-4 rounded-2xl shadow-xl border border-slate-700 flex items-center gap-4 animate-in z-[100] whitespace-nowrap"><Icons.CheckCircle size={24} className="text-emerald-400" /><span className="font-bold text-sm tracking-widest uppercase">{notification}</span></div>)}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
